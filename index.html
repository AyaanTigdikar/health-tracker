<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PERFORMANCE - Health Dashboard</title>

  <!-- Libraries -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/index.min.js"></script>

  <!-- Ubuntu font -->
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet" />

  <style>
    /* -------------------------
       Design tokens & reset
       ------------------------- */
    * { box-sizing: border-box; margin: 0; padding: 0; }
    :root {
      --orange: #FC4C02;
      --dark: #0D0D0D;
      --gray: #1C1C1C;
      --light-gray: #2D2D2D;
      --border: #333333;
      --text: #FFFFFF;
      --subtext: #999999;
      --success: #00D964;
      --warning: #FFB700;
      --danger: #CC3300;
      --dark-orange: #E54502;
      --ubuntu: "Ubuntu", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    html,body { height: 100%; background: var(--dark); color: var(--text); font-family: var(--ubuntu); -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* -------------------------
       Layout
       ------------------------- */
    .app-container { display:flex; height:100vh; overflow:hidden; }
    .sidebar {
      width: 280px; background: var(--gray); border-right:1px solid var(--border);
      padding: 30px 20px; display:flex; flex-direction:column;
    }
    .main-content {
      flex:1; overflow-y:auto; padding:30px; background:var(--dark);
    }

    /* -------------------------
       Sidebar content
       ------------------------- */
    .app-logo { font-size:24px; font-weight:700; color:var(--orange); display:flex; align-items:center; gap:10px; letter-spacing:-0.5px; }
    .app-tagline { font-size:11px; color:var(--subtext); margin-top:6px; text-transform:uppercase; letter-spacing:1px; }

    .target-widget {
      background:var(--light-gray); border-radius:12px; padding:20px; margin:22px 0; border:1px solid var(--border);
    }
    .target-label { font-size:11px; color:var(--subtext); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; font-weight:500; }
    .target-date-display { font-size:18px; font-weight:600; color:var(--text); margin-bottom:12px; }
    .countdown-display { background:var(--orange); color:white; padding:12px; border-radius:8px; text-align:center; font-weight:700; font-size:15px; }

    .sync-indicator { display:flex; gap:8px; align-items:center; padding:12px; background:var(--light-gray); border-radius:8px; margin-bottom:22px; border:1px solid var(--border); font-size:13px; }
    .sync-indicator.syncing { border-color:var(--orange); color:var(--orange); }
    .sync-indicator.synced { border-color:var(--success); color:var(--success); }
    .sync-indicator.error { border-color:var(--warning); color:var(--warning); }

    .action-buttons { display:flex; flex-direction:column; gap:10px; margin-top:auto; }
    .btn { border-radius:8px; padding:12px 16px; cursor:pointer; font-weight:600; font-size:13px; border:none; }
    .btn-primary { background:var(--orange); color:#fff; text-transform:uppercase; letter-spacing:0.6px; }
    .btn-primary:hover { background:var(--dark-orange); transform:translateY(-1px); }
    .btn-secondary { background:transparent; color:var(--subtext); border:1px solid var(--border); }
    .btn-secondary:hover { background:var(--light-gray); color:var(--text); border-color:var(--subtext); }

    /* -------------------------
       Main header & grid
       ------------------------- */
    .dashboard-header { margin-bottom: 24px; }
    .dashboard-title { font-size:32px; font-weight:700; color:var(--text); margin-bottom:8px; }
    .dashboard-subtitle { font-size:14px; color:var(--subtext); }

    .dashboard-grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap:20px; grid-auto-flow:dense; }

    .chart-card {
      background:var(--gray); border:1px solid var(--border); border-radius:12px; padding:20px;
      transition:all .18s ease; position:relative;
    }
    .chart-card.large { grid-column: span 2; }
    .chart-card:hover { border-color:var(--orange); transform:translateY(-3px); box-shadow:0 10px 30px rgba(252,76,2,0.08); }

    .chart-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
    .chart-title { font-size:14px; font-weight:700; text-transform:uppercase; color:var(--text); letter-spacing:0.6px; }
    .chart-value { font-size:28px; font-weight:700; color:var(--orange); }

    /* -------------------------
       Calorie tracker
       ------------------------- */
    .calorie-tracker { background:var(--gray); border:1px solid var(--border); border-radius:12px; padding:20px; margin-bottom:20px; }
    .calorie-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:14px; }
    .calorie-title { font-size:18px; font-weight:700; text-transform:uppercase; letter-spacing:0.6px; }
    .calorie-stats { display:grid; grid-template-columns: repeat(4, 1fr); gap:12px; margin-bottom:12px; }
    .calorie-stat { background:var(--dark); padding:12px; border-radius:8px; text-align:center; }
    .calorie-stat-value { font-size:20px; font-weight:700; color:var(--orange); margin-bottom:6px; }
    .calorie-stat-label { font-size:11px; color:var(--subtext); text-transform:uppercase; letter-spacing:0.6px; }

    .progress-section { background:var(--dark); padding:16px; border-radius:8px; margin-top:10px; }
    .progress-bar-container { background:var(--gray); border-radius:8px; padding:6px; margin-bottom:8px; }
    .progress-bar-cells { display:grid; grid-template-columns: repeat(20, 1fr); gap:6px; height:16px; }
    .progress-cell { background:var(--light-gray); border-radius:4px; }
    .progress-cell.filled { background:var(--orange); box-shadow:0 0 6px rgba(252,76,2,0.18); }

    /* small inline inputs used inside cards */
    .small-input { padding:8px 10px; background:var(--dark); border:1px solid var(--border); border-radius:8px; color:var(--text); }

    /* -------------------------
       Meal tracker
       ------------------------- */
    .meal-tracker-card { background:var(--gray); border:2px solid var(--orange); border-radius:12px; padding:20px; position:relative; grid-column:span 2; }
    .meal-tracker-card::before { content:'DEFAULT TRACKER'; position:absolute; top:-10px; left:20px; background:var(--orange); color:#fff; padding:4px 8px; border-radius:6px; font-size:10px; font-weight:700; letter-spacing:1px; }

    .meal-input-section { display:grid; grid-template-columns: 2fr 1fr 1fr auto; gap:10px; margin-bottom:12px; padding:10px; background:var(--dark); border-radius:8px; }
    .meal-type-select, .meal-time-input, .meal-calorie-input { background:var(--light-gray); border:1px solid var(--border); color:var(--text); padding:10px; border-radius:6px; }
    .add-meal-btn { background:var(--orange); color:white; padding:10px 14px; border-radius:6px; border:none; cursor:pointer; }

    .meal-visualizations { display:grid; grid-template-columns: 1fr 1fr; gap:18px; }
    .meal-viz-section { background:var(--dark); padding:12px; border-radius:8px; }
    .meal-timeline { position:relative; height:170px; }
    .meal-timeline-axis { position:absolute; left:0; right:0; height:2px; background:var(--border); top:50%; border-radius:2px; }
    .meal-marker { position:absolute; width:12px; height:12px; border-radius:50%; border:2px solid var(--dark); transform:translate(-50%,-50%); cursor:pointer; transition:all .12s ease; }
    .time-labels { display:flex; justify-content:space-between; font-size:11px; color:var(--subtext); margin-top:10px; }

    .meal-category { display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--gray); border-radius:6px; margin-bottom:8px; }
    .meal-category-name { font-size:13px; color:var(--text); font-weight:500; }
    .meal-category-calories { font-size:16px; font-weight:700; color:var(--orange); }

    /* -------------------------
       Modals, tables, misc
       ------------------------- */
    .modal { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.78); z-index:1200; align-items:center; justify-content:center; padding:20px; }
    .modal.active { display:flex; }
    .modal-content { background:var(--gray); border:1px solid var(--border); border-radius:14px; padding:28px; max-width:820px; width:100%; max-height:86vh; overflow:auto; }
    .modal-header { margin-bottom:18px; }
    .modal-title { font-size:20px; font-weight:700; color:var(--text); margin-bottom:6px; }
    .modal-subtitle { color:var(--subtext); font-size:13px; margin-bottom:2px; }

    .form-group { margin-bottom:14px; }
    .form-label { display:block; margin-bottom:8px; color:var(--text); font-size:12px; text-transform:uppercase; letter-spacing:0.6px; }
    .form-input { width:100%; padding:10px 12px; background:var(--dark); border:1px solid var(--border); border-radius:8px; color:var(--text); }

    .chart-container { position:relative; height:220px; }

    /* small touches */
    .menu-dots { width:34px; height:34px; border-radius:50%; border:1px solid var(--border); display:inline-flex; align-items:center; justify-content:center; background:transparent; color:var(--subtext); cursor:pointer; }
    .menu-dropdown { position:absolute; right:0; top:40px; background:var(--gray); border:1px solid var(--border); border-radius:8px; display:none; min-width:160px; overflow:hidden; z-index:200; }
    .menu-dropdown.active { display:block; }
    .menu-item { display:block; padding:10px 12px; color:var(--text); text-align:left; background:transparent; border:none; width:100%; cursor:pointer; }
    .menu-item:hover { background:var(--orange); color:#fff; }

    /* responsive tweaks */
    @media (max-width: 920px) {
      .sidebar { display:none; }
      .meal-tracker-card { grid-column: span 1; }
    }

    /* small spinner */
    .loading-spinner { width:14px; height:14px; border-radius:50%; border:2px solid rgba(252,76,2,0.18); border-top-color:var(--orange); animation:spin 1s linear infinite; display:inline-block; }
    @keyframes spin { to { transform:rotate(360deg); } }
  </style>
</head>

<body onload="init()">
  <div class="app-container">
    <!-- SIDEBAR -->
    <aside class="sidebar" aria-label="Sidebar">
      <div class="logo-section">
        <div class="app-logo">
          <span>💪</span><span>PERFORMANCE</span>
        </div>
        <div class="app-tagline">Track • Analyze • Achieve</div>
      </div>

      <div class="target-widget" aria-hidden="false">
        <div class="target-label">Target Date</div>
        <div class="target-date-display" id="targetDisplay">Not Set</div>
        <div class="countdown-display" id="countdown">Set Your Goal</div>
      </div>

      <div id="syncStatus" class="sync-indicator">
        <span id="syncIcon">🔄</span>
        <span id="syncText">Checking...</span>
      </div>

      <div class="action-buttons">
        <button class="btn btn-primary" onclick="openAddModal()">+ Add Chart</button>
        <button class="btn btn-secondary" onclick="openSettingsModal()">⚙️ Settings</button>
      </div>
    </aside>

    <!-- MAIN -->
    <main class="main-content">
      <!-- Calorie Tracker -->
      <section id="calorieTracker" class="calorie-tracker" aria-labelledby="calorieHeading">
        <div class="calorie-header">
          <h2 id="calorieHeading" class="calorie-title">Daily Calorie Balance</h2>
          <span id="todayDate"></span>
        </div>

        <div class="calorie-stats">
          <div class="calorie-stat">
            <div class="calorie-stat-value" id="caloriesIn">0</div>
            <div class="calorie-stat-label">Calories In</div>
          </div>
          <div class="calorie-stat">
            <div class="calorie-stat-value" id="caloriesOut">0</div>
            <div class="calorie-stat-label">Calories Burned</div>
          </div>
          <div class="calorie-stat" id="netCaloriesStat">
            <div class="calorie-stat-value" id="netCalories">0</div>
            <div class="calorie-stat-label">Net Balance</div>
          </div>
          <div class="calorie-stat">
            <div class="calorie-stat-value" id="dailyTarget">2000</div>
            <div class="calorie-stat-label">Daily Target</div>
          </div>
        </div>

        <!-- Inline: calories burned quick input (main tracker) -->
        <div style="display:flex; gap:10px; align-items:center; margin-top:8px;">
          <input id="trackerCaloriesBurnedInput" class="small-input" type="number" placeholder="Calories burned (exercise)" aria-label="Calories burned input" />
          <button class="btn btn-primary" style="padding:9px 12px;" onclick="saveCaloriesBurnedFromTracker()">Save Burn</button>
          <button class="btn btn-secondary" style="padding:9px 12px;" onclick="clearTrackerBurnInput()">Clear</button>
        </div>

        <div class="progress-section" aria-live="polite" style="margin-top:14px;">
          <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
            <div class="progress-title">Weight Goal Progress</div>
            <div style="font-size:12px; color:var(--subtext)">Progress toward target weight</div>
          </div>

          <div class="progress-bar-container">
            <div id="progressCells" class="progress-bar-cells" aria-hidden="true"></div>
          </div>

          <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--subtext); font-size:13px;">
            <div>Total Deficit Needed: <strong id="totalDeficitNeeded">0</strong> kcal</div>
            <div><span id="progressPercentage">0</span>% Complete</div>
          </div>

          <div style="display:flex; justify-content:space-between; margin-top:8px; color:var(--subtext); font-size:13px;">
            <div>Deficit Achieved: <strong id="deficitAchieved" style="color:var(--success)">0</strong> kcal</div>
            <div>Remaining: <strong id="deficitRemaining" style="color:var(--orange)">0</strong> kcal</div>
          </div>
        </div>
      </section>

      <!-- Header -->
      <header class="dashboard-header">
        <h1 class="dashboard-title">Your Dashboard</h1>
        <p class="dashboard-subtitle" id="dashboardSubtitle">Loading your performance data...</p>
      </header>

      <!-- Content grid -->
      <div id="dashboardContent" class="dashboard-grid" aria-live="polite">
        <!-- Cards inserted dynamically -->
      </div>
    </main>
  </div>

  <!-- Floating action button -->
  <button class="btn btn-primary" style="position:fixed; right:28px; bottom:28px; border-radius:999px; width:60px; height:60px; font-size:22px; z-index:200;" title="Add Daily Update" onclick="openDailyUpdateModal()">📊</button>

  <!-- -------------------------
       SETTINGS modal (weight targets, meal times, GitHub)
       ------------------------- -->
  <div id="settingsModal" class="modal" aria-hidden="true">
    <div class="modal-content" role="dialog" aria-modal="true" aria-labelledby="settingsTitle">
      <div class="modal-header">
        <h3 id="settingsTitle" class="modal-title">Settings</h3>
        <div class="modal-subtitle">Configure goals, meal times and sync</div>
      </div>

      <section>
        <h4 style="color:var(--text); margin-bottom:10px; font-size:15px; font-weight:700;">Weight Goals</h4>
        <div class="form-group">
          <label class="form-label">Target Date</label>
          <input id="settingsTargetDate" class="form-input" type="date" />
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group">
            <label class="form-label">Current Weight (kg)</label>
            <input id="settingsCurrentWeight" class="form-input" type="number" step="0.1" placeholder="e.g., 75" />
          </div>
          <div class="form-group">
            <label class="form-label">Target Weight (kg)</label>
            <input id="settingsTargetWeight" class="form-input" type="number" step="0.1" placeholder="e.g., 70" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Daily Calorie Target</label>
          <input id="settingsDailyCalories" class="form-input" type="number" placeholder="e.g., 2000" />
        </div>
      </section>

      <section style="margin-top:16px;">
        <h4 style="color:var(--text); margin-bottom:10px; font-size:15px; font-weight:700;">Ideal Meal Times</h4>
        <div style="display:grid; grid-template-columns:repeat(3, 1fr); gap:12px;">
          <div class="form-group">
            <label class="form-label">Breakfast</label>
            <input id="settingsBreakfast" class="form-input" type="time" />
          </div>
          <div class="form-group">
            <label class="form-label">Lunch</label>
            <input id="settingsLunch" class="form-input" type="time" />
          </div>
          <div class="form-group">
            <label class="form-label">Dinner</label>
            <input id="settingsDinner" class="form-input" type="time" />
          </div>
        </div>
      </section>

      <section style="margin-top:16px;">
        <h4 style="color:var(--text); margin-bottom:10px; font-size:15px; font-weight:700;">GitHub Sync</h4>
        <div class="form-group alert" style="background:rgba(252,76,2,0.06); border:1px solid rgba(252,76,2,0.14); color:var(--orange);">
          <span>ℹ️</span>
          <div style="margin-left:10px; font-size:13px;">Your data will be stored in your GitHub repository. Use a token with repo scope.</div>
        </div>

        <div class="form-group">
          <label class="form-label">Personal Access Token</label>
          <input id="settingsGithubToken" type="password" class="form-input" placeholder="ghp_xxxxxx" />
        </div>

        <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
          <div class="form-group">
            <label class="form-label">GitHub Username</label>
            <input id="settingsGithubUsername" class="form-input" type="text" />
          </div>
          <div class="form-group">
            <label class="form-label">Repository</label>
            <input id="settingsGithubRepo" class="form-input" type="text" placeholder="health-tracker" />
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">Branch</label>
          <input id="settingsGithubBranch" class="form-input" type="text" value="main" />
        </div>
      </section>

      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:16px;">
        <button class="btn btn-secondary" onclick="closeSettingsModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveSettings()">Save Settings</button>
      </div>
    </div>
  </div>

  <!-- -------------------------
       Setup modal (initial)
       ------------------------- -->
  <div id="setupModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Welcome to PERFORMANCE</h3>
        <div class="modal-subtitle">Let's set up your fitness goals</div>
      </div>

      <div class="form-group">
        <label class="form-label">Target Date</label>
        <input id="targetDateInput" type="date" class="form-input" />
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px;">
        <div class="form-group">
          <label class="form-label">Current Weight (kg)</label>
          <input id="currentWeightInput" class="form-input" type="number" step="0.1" />
        </div>
        <div class="form-group">
          <label class="form-label">Target Weight (kg)</label>
          <input id="targetWeightInput" class="form-input" type="number" step="0.1" />
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Daily Calorie Target</label>
        <input id="dailyCalorieInput" type="number" class="form-input" value="2000" />
      </div>

      <div style="display:flex; gap:12px; justify-content:flex-end;">
        <button class="btn btn-secondary" onclick="skipSetup()">Skip for Now</button>
        <button class="btn btn-primary" onclick="setTarget()">Set Targets</button>
      </div>
    </div>
  </div>

  <!-- -------------------------
       Daily Update modal
       ------------------------- -->
  <div id="dailyUpdateModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">Daily Update</h3>
        <div class="modal-subtitle">Quick entry for today's metrics</div>
      </div>

      <div class="form-group">
        <label class="form-label">Calories Burned Today</label>
        <input id="dailyCaloriesBurned" class="form-input" type="number" placeholder="e.g., 500" />
        <div class="form-hint" style="color:var(--subtext); margin-top:6px;">Enter total calories burned from exercise</div>
      </div>

      <div id="dailyUpdateCharts"></div>

      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:12px;">
        <button class="btn btn-secondary" onclick="closeDailyUpdateModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveDailyUpdate()">Save Update</button>
      </div>
    </div>
  </div>

  <!-- -------------------------
       Chart add/edit modal
       ------------------------- -->
  <div id="chartModal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <div class="modal-header">
        <h3 id="modalTitle" class="modal-title">Add New Chart</h3>
        <div class="modal-subtitle">Configure your tracking metrics</div>
      </div>

      <div class="form-group">
        <label class="form-label">Chart Name</label>
        <input id="chartName" class="form-input" type="text" placeholder="e.g., Daily Steps" />
      </div>

      <div class="form-group">
        <label class="form-label">Chart Type</label>
        <div style="display:flex; gap:8px;">
          <button class="btn btn-secondary" onclick="selectChartType('line')" id="btnTypeLine">📈 LINE</button>
          <button class="btn btn-secondary" onclick="selectChartType('bar')" id="btnTypeBar">📊 BAR</button>
          <button class="btn btn-secondary" onclick="selectChartType('heatmap')" id="btnTypeHeatmap">🌡️ HEATMAP</button>
        </div>
      </div>

      <div id="goalSection" class="form-group">
        <label class="form-label">Daily Goal (Optional)</label>
        <input id="dailyGoal" class="form-input" type="number" placeholder="Leave blank if no goal" />
      </div>

      <div id="dataEntrySection" class="form-group">
        <label class="form-label">Data Entry</label>
        <table style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th style="text-align:left; color:var(--subtext); font-size:12px;">Date</th>
              <th style="text-align:left; color:var(--subtext); font-size:12px;"><input id="columnHeader" class="form-input" value="Value" /></th>
              <th></th>
            </tr>
          </thead>
          <tbody id="dataTableBody"></tbody>
        </table>
        <div style="margin-top:10px;">
          <button class="btn btn-secondary" onclick="addDataRow()">+ Add Row</button>
        </div>
      </div>

      <div id="heatmapDataSection" style="display:none;">
        <label class="form-label">Heatmap Data Entry</label>
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
          <input id="heatmapDateTime" class="form-input" type="datetime-local" />
          <input id="heatmapIntensity" class="form-input" type="number" placeholder="Intensity" />
        </div>
        <div style="margin-top:10px;">
          <button class="btn btn-secondary" onclick="addHeatmapEntry()">+ Add Entry</button>
        </div>
        <div id="heatmapEntriesList" style="margin-top:12px; max-height:200px; overflow:auto; padding:10px; background:var(--dark); border-radius:8px; border:1px solid var(--border); color:var(--subtext);">
          No entries yet
        </div>
      </div>

      <div style="display:flex; gap:12px; justify-content:flex-end; margin-top:14px;">
        <button class="btn btn-secondary" onclick="closeChartModal()">Cancel</button>
        <button class="btn btn-primary" onclick="saveChart()">Save Chart</button>
      </div>
    </div>
  </div>

  <!-- -------------------------
       SCRIPT (organized & cleaned)
       ------------------------- -->
  <script>
    /* ============================
       App state & defaults
       ============================ */
    const githubConfigKey = 'githubConfig';
    const dataKey = 'healthTrackerData';

    let githubConfig = { token:'', username:'', repo:'', branch:'main', useGithub:false };
    let lastSha = null;

    let appData = {
      targetDate: null,
      currentWeight: null,
      targetWeight: null,
      dailyCalorieTarget: 2000,
      idealMealTimes: { breakfast:'08:30', lunch:'13:00', dinner:'18:00' },
      charts: []
    };

    // ephemeral UI state
    let currentEditingChart = null;
    let selectedChartType = 'line';
    let heatmapTempData = [];

    // Chart.js defaults (font, colours)
    Chart.defaults.color = '#999999';
    Chart.defaults.borderColor = '#333333';
    Chart.defaults.font.family = 'Ubuntu, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif';

    /* ============================
       Initialization
       ============================ */
    async function init(){
      loadGithubConfigFromStorage();
      loadLocalData();

      ensureMealTracker();
      ensureCaloriesBurnedChart();

      // set UI date min
      const todayISO = new Date().toISOString().split('T')[0];
      const targetInput = document.getElementById('targetDateInput');
      if (targetInput) targetInput.setAttribute('min', todayISO);

      // display today
      const todayLabel = document.getElementById('todayDate');
      if (todayLabel) todayLabel.textContent = new Date().toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });

      // if GitHub configured, try load
      if (githubConfig.useGithub && githubConfig.token && githubConfig.username && githubConfig.repo) {
        await loadFromGithub();
      }

      // show setup modal if not configured
      if (!appData.targetDate) {
        document.getElementById('setupModal').classList.add('active');
      } else {
        updateDashboard();
        startCountdown();
        updateCalorieTracker();
        updateProgressBar();
      }

      // safety: update meal tracker UI if meal tracker exists
      updateMealTracker();
    }

    /* ============================
       Storage: GitHub & local
       ============================ */
    function loadGithubConfigFromStorage(){
      try {
        const saved = localStorage.getItem(githubConfigKey);
        if (saved) githubConfig = JSON.parse(saved);
      } catch (e) {
        console.error('loadGithubConfig error', e);
      }
    }

    function persistGithubConfig(){
      localStorage.setItem(githubConfigKey, JSON.stringify(githubConfig));
    }

    function loadLocalData(){
      try {
        const saved = localStorage.getItem(dataKey);
        if (saved) {
          const parsed = JSON.parse(saved);
          appData = Object.assign(appData, parsed);
          // ensure idealMealTimes exists
          appData.idealMealTimes = Object.assign({ breakfast:'08:30', lunch:'13:00', dinner:'18:00' }, appData.idealMealTimes || {});
        }
      } catch(e){
        console.error('loadLocalData', e);
      }
    }

    function saveLocalData(){
      localStorage.setItem(dataKey, JSON.stringify(appData));
      updateSyncStatus('offline', 'Saved Locally');
    }

    async function loadFromGithub(){
      if (!githubConfig.useGithub) return;

      updateSyncStatus('syncing', 'Syncing...');
      try {
        const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/health-data.json?ref=${githubConfig.branch}`;
        const resp = await fetch(url, { headers:{ 'Authorization': `token ${githubConfig.token}`, 'Accept':'application/vnd.github.v3+json' }});
        if (resp.status === 404) { updateSyncStatus('synced','GitHub Ready'); return; }
        if (!resp.ok) throw new Error('GitHub load error ' + resp.status);
        const data = await resp.json();
        lastSha = data.sha;
        const content = atob(data.content);
        const parsed = JSON.parse(content);
        appData = Object.assign(appData, parsed);
        appData.idealMealTimes = Object.assign({ breakfast:'08:30', lunch:'13:00', dinner:'18:00' }, appData.idealMealTimes || {});
        localStorage.setItem(dataKey, JSON.stringify(appData));
        updateSyncStatus('synced','GitHub Synced');
      } catch (err) {
        console.error('loadFromGithub', err);
        updateSyncStatus('error', 'Sync Failed');
        loadLocalData();
      }
    }

    async function saveToGithub(){
      if (!githubConfig.useGithub) return saveLocalData();
      updateSyncStatus('syncing', 'Saving...');
      try {
        const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/health-data.json`;
        const content = btoa(JSON.stringify(appData, null, 2));
        const body = { message:`Update health data - ${new Date().toLocaleString()}`, content, branch: githubConfig.branch };
        if (lastSha) body.sha = lastSha;
        const resp = await fetch(url, { method:'PUT', headers:{ 'Authorization': `token ${githubConfig.token}`, 'Accept':'application/vnd.github.v3+json', 'Content-Type':'application/json' }, body:JSON.stringify(body) });
        if (!resp.ok) {
          const text = await resp.text().catch(()=> '');
          throw new Error(`GitHub save error ${resp.status} ${text}`);
        }
        const respJson = await resp.json();
        lastSha = respJson.content?.sha || lastSha;
        localStorage.setItem(dataKey, JSON.stringify(appData));
        updateSyncStatus('synced', 'Saved to GitHub');
      } catch (err) {
        console.error('saveToGithub', err);
        updateSyncStatus('error', 'Save Failed - Local Saved');
        saveLocalData();
      }
    }

    async function saveData(){
      if (githubConfig.useGithub) await saveToGithub();
      else saveLocalData();
    }

    /* ============================
       UI: sync status helper
       ============================ */
    function updateSyncStatus(status, text){
      const statusEl = document.getElementById('syncStatus');
      const iconEl = document.getElementById('syncIcon');
      const textEl = document.getElementById('syncText');
      if (!statusEl || !iconEl || !textEl) return;
      statusEl.className = 'sync-indicator';
      switch(status){
        case 'syncing': statusEl.classList.add('syncing'); iconEl.innerHTML = '<span class="loading-spinner"></span>'; break;
        case 'synced': statusEl.classList.add('synced'); iconEl.textContent = '✔'; break;
        case 'error': statusEl.classList.add('error'); iconEl.textContent = '⚠️'; break;
        case 'offline': iconEl.textContent = '💾'; break;
      }
      textEl.textContent = text;
    }

    /* ============================
       Ensure base trackers exist
       ============================ */
    function ensureMealTracker(){
      if (!appData.charts) appData.charts = [];
      const exists = appData.charts.some(c=>c.id==='meal_tracker');
      if (!exists) {
        appData.charts.unshift({
          id:'meal_tracker',
          name:'Meal Tracker',
          type:'meal',
          dataLabel:'Calories',
          mealData: [],
          permanent:true
        });
        saveLocalData();
      }
    }

    function ensureCaloriesBurnedChart(){
      if (!appData.charts) appData.charts = [];
      const exists = appData.charts.some(c=>c.id==='calories_burned');
      if (!exists) {
        appData.charts.push({
          id:'calories_burned',
          name:'Calories Burned',
          type:'bar',
          dataLabel:'Calories',
          data: [],
          goal: null,
          permanent:true
        });
        saveLocalData();
      }
    }

    /* ============================
       SETTINGS modal actions
       ============================ */
    function openSettingsModal(){
      document.getElementById('settingsTargetDate').value = appData.targetDate || '';
      document.getElementById('settingsCurrentWeight').value = appData.currentWeight || '';
      document.getElementById('settingsTargetWeight').value = appData.targetWeight || '';
      document.getElementById('settingsDailyCalories').value = appData.dailyCalorieTarget || 2000;

      document.getElementById('settingsBreakfast').value = appData.idealMealTimes?.breakfast || '08:30';
      document.getElementById('settingsLunch').value = appData.idealMealTimes?.lunch || '13:00';
      document.getElementById('settingsDinner').value = appData.idealMealTimes?.dinner || '18:00';

      document.getElementById('settingsGithubToken').value = githubConfig.token || '';
      document.getElementById('settingsGithubUsername').value = githubConfig.username || '';
      document.getElementById('settingsGithubRepo').value = githubConfig.repo || '';
      document.getElementById('settingsGithubBranch').value = githubConfig.branch || 'main';

      document.getElementById('settingsModal').classList.add('active');
    }

    function closeSettingsModal(){ document.getElementById('settingsModal').classList.remove('active'); }

    async function saveSettings(){
      // weight & targets
      appData.targetDate = document.getElementById('settingsTargetDate').value || appData.targetDate;
      appData.currentWeight = parseFloat(document.getElementById('settingsCurrentWeight').value) || appData.currentWeight;
      appData.targetWeight = parseFloat(document.getElementById('settingsTargetWeight').value) || appData.targetWeight;
      appData.dailyCalorieTarget = parseFloat(document.getElementById('settingsDailyCalories').value) || appData.dailyCalorieTarget;

      // meal times
      appData.idealMealTimes = {
        breakfast: document.getElementById('settingsBreakfast').value || '08:30',
        lunch: document.getElementById('settingsLunch').value || '13:00',
        dinner: document.getElementById('settingsDinner').value || '18:00'
      };

      // github
      const token = document.getElementById('settingsGithubToken').value.trim();
      const username = document.getElementById('settingsGithubUsername').value.trim();
      const repo = document.getElementById('settingsGithubRepo').value.trim();
      const branch = document.getElementById('settingsGithubBranch').value.trim() || 'main';

      if (token && username && repo) {
        githubConfig = { token, username, repo, branch, useGithub:true };
      } else {
        githubConfig.useGithub = false;
      }
      persistGithubConfig();

      await saveData();
      closeSettingsModal();
      updateDashboard();
      startCountdown();
      updateCalorieTracker();
      updateProgressBar();
    }

    /* ============================
       Setup modal
       ============================ */
    function skipSetup(){ document.getElementById('setupModal').classList.remove('active'); updateDashboard(); }
    async function setTarget(){
      const dateInput = document.getElementById('targetDateInput').value;
      const currentWeight = parseFloat(document.getElementById('currentWeightInput').value);
      const targetWeight = parseFloat(document.getElementById('targetWeightInput').value);
      const dailyCalories = parseFloat(document.getElementById('dailyCalorieInput').value) || 2000;

      if (!dateInput || !currentWeight || !targetWeight) { alert('Please fill in required fields'); return; }

      appData.targetDate = dateInput;
      appData.currentWeight = currentWeight;
      appData.targetWeight = targetWeight;
      appData.dailyCalorieTarget = dailyCalories;

      await saveData();
      document.getElementById('setupModal').classList.remove('active');
      updateDashboard();
      startCountdown();
      updateCalorieTracker();
      updateProgressBar();
    }

    /* ============================
       Countdown
       ============================ */
    function startCountdown(){
      updateCountdown();
      setInterval(updateCountdown, 1000*60);
    }
    function updateCountdown(){
      const display = document.getElementById('targetDisplay');
      const cd = document.getElementById('countdown');
      if (!appData.targetDate) { display.textContent='Not Set'; cd.textContent='Set Your Goal'; return; }
      const target = new Date(appData.targetDate);
      display.textContent = target.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
      const diff = target - new Date();
      if (diff <= 0) { cd.textContent='🏆 ACHIEVED!'; return; }
      const days = Math.floor(diff / (1000*60*60*24));
      cd.textContent = `${days} DAYS TO GO`;
    }

    /* ============================
       Daily update modal
       ============================ */
    function openDailyUpdateModal(){
      const today = new Date().toISOString().split('T')[0];
      // populate calories burned for today
      const calorieChart = appData.charts.find(c=>c.id==='calories_burned');
      if (calorieChart && calorieChart.data) {
        const todayData = calorieChart.data.find(d=>d.date===today);
        document.getElementById('dailyCaloriesBurned').value = todayData ? todayData.value : '';
      } else {
        document.getElementById('dailyCaloriesBurned').value = '';
      }

      // dynamic other chart inputs
      const container = document.getElementById('dailyUpdateCharts');
      container.innerHTML = '';
      appData.charts.forEach(chart=>{
        if (chart.id !== 'meal_tracker' && chart.id !== 'calories_burned' && chart.type !== 'heatmap') {
          const div = document.createElement('div');
          div.className = 'form-group';
          const todayData = (chart.data||[]).find(d=>d.date===today);
          div.innerHTML = `<label class="form-label">${chart.name}</label>
            <input class="form-input daily-chart-input" data-chart-id="${chart.id}" type="number" placeholder="Enter today's ${chart.dataLabel||'value'}" value="${todayData?todayData.value:''}" />`;
          container.appendChild(div);
        }
      });

      document.getElementById('dailyUpdateModal').classList.add('active');
    }
    function closeDailyUpdateModal(){ document.getElementById('dailyUpdateModal').classList.remove('active'); }

    async function saveDailyUpdate(){
      const today = new Date().toISOString().split('T')[0];
      // calories burned
      const burned = parseFloat(document.getElementById('dailyCaloriesBurned').value);
      if (!isNaN(burned)) {
        const chart = appData.charts.find(c=>c.id==='calories_burned');
        if (!chart.data) chart.data = [];
        const idx = chart.data.findIndex(d=>d.date===today);
        if (idx !== -1) chart.data[idx].value = burned;
        else chart.data.push({ date:today, value:burned });
        chart.data.sort((a,b)=>new Date(a.date)-new Date(b.date));
      }

      // other charts
      document.querySelectorAll('.daily-chart-input').forEach(input=>{
        const chartId = input.dataset.chartId;
        const value = parseFloat(input.value);
        if (isNaN(value)) return;
        const chart = appData.charts.find(c=>c.id===chartId);
        if (!chart) return;
        if (!chart.data) chart.data = [];
        const idx = chart.data.findIndex(d=>d.date===today);
        if (idx !== -1) chart.data[idx].value = value;
        else chart.data.push({ date:today, value });
        chart.data.sort((a,b)=>new Date(a.date)-new Date(b.date));
      });

      await saveData();
      updateDashboard();
      updateCalorieTracker();
      updateProgressBar();
      document.getElementById('dailyUpdateModal').classList.remove('active');
    }

    /* ============================
       Chart add/edit modal helpers
       ============================ */
    function openAddModal(){
      currentEditingChart = null;
      heatmapTempData = [];
      selectedChartType = 'line';
      document.getElementById('modalTitle').textContent = 'Add New Chart';
      document.getElementById('chartName').value = '';
      document.getElementById('dailyGoal').value = '';
      document.getElementById('columnHeader').value = 'Value';
      document.getElementById('dataTableBody').innerHTML = '';
      document.getElementById('heatmapEntriesList').innerHTML = 'No entries yet';
      updateChartTypeButtons();
      updateDataEntryVisibility();
      addDataRow();
      // set default datetime to now
      const dt = new Date(); dt.setMinutes(dt.getMinutes() - dt.getTimezoneOffset());
      const dtEl = document.getElementById('heatmapDateTime'); if (dtEl) dtEl.value = dt.toISOString().slice(0,16);
      document.getElementById('chartModal').classList.add('active');
    }

    function closeChartModal(){ document.getElementById('chartModal').classList.remove('active'); }

    function selectChartType(type){
      selectedChartType = type;
      updateChartTypeButtons();
      updateDataEntryVisibility();
    }

    function updateChartTypeButtons(){
      ['btnTypeLine','btnTypeBar','btnTypeHeatmap'].forEach(id=>{
        const el = document.getElementById(id);
        if (!el) return;
        el.classList.remove('btn-primary'); el.classList.add('btn-secondary');
      });
      if (selectedChartType === 'line') document.getElementById('btnTypeLine').classList.add('btn-primary');
      if (selectedChartType === 'bar') document.getElementById('btnTypeBar').classList.add('btn-primary');
      if (selectedChartType === 'heatmap') document.getElementById('btnTypeHeatmap').classList.add('btn-primary');
    }

    function updateDataEntryVisibility(){
      const regular = document.getElementById('dataEntrySection');
      const heat = document.getElementById('heatmapDataSection');
      const goal = document.getElementById('goalSection');
      if (selectedChartType === 'heatmap') { regular.style.display='none'; heat.style.display='block'; goal.style.display='none'; }
      else { regular.style.display='block'; heat.style.display='none'; goal.style.display='block'; }
    }

    function addHeatmapEntry(){
      const datetime = document.getElementById('heatmapDateTime').value;
      const intensity = parseFloat(document.getElementById('heatmapIntensity').value);
      if (!datetime || isNaN(intensity)) { alert('Enter date/time and intensity'); return; }
      heatmapTempData.push({ datetime, intensity });
      updateHeatmapEntriesList();
      document.getElementById('heatmapIntensity').value = '';
    }

    function updateHeatmapEntriesList(){
      const list = document.getElementById('heatmapEntriesList');
      if (!heatmapTempData.length) { list.innerHTML = 'No entries yet'; return; }
      heatmapTempData.sort((a,b)=> new Date(a.datetime) - new Date(b.datetime));
      list.innerHTML = heatmapTempData.map((e,i) => {
        const d = new Date(e.datetime);
        const fmt = d.toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
        return `<div style="display:flex; justify-content:space-between; align-items:center; padding:8px; border-bottom:1px solid var(--border);">
            <div style="color:var(--text)">${fmt} — <strong style="color:var(--orange)">${e.intensity}</strong></div>
            <button class="btn btn-secondary" onclick="removeHeatmapEntry(${i})">Remove</button>
          </div>`;
      }).join('');
    }

    function removeHeatmapEntry(i){ heatmapTempData.splice(i,1); updateHeatmapEntriesList(); }

    function addDataRow(date='', value=''){
      const tbody = document.getElementById('dataTableBody');
      const tr = document.createElement('tr');
      const todayISO = new Date().toISOString().split('T')[0];
      tr.innerHTML = `<td><input type="date" class="form-input" value="${date}" max="${todayISO}" /></td>
                      <td><input type="number" class="form-input" value="${value}" /></td>
                      <td><button class="btn btn-secondary" onclick="this.closest('tr').remove()">Delete</button></td>`;
      tbody.appendChild(tr);
    }

    async function saveChart(){
      const name = document.getElementById('chartName').value.trim();
      if (!name) { alert('Chart must have a name'); return; }

      if (selectedChartType === 'heatmap') {
        if (!heatmapTempData.length) { alert('Add at least one heatmap entry'); return; }
        const label = document.getElementById('columnHeader').value || 'Intensity';
        if (currentEditingChart) {
          const chart = appData.charts.find(c=>c.id===currentEditingChart);
          chart.name = name; chart.type='heatmap'; chart.dataLabel = label; chart.heatmapData = heatmapTempData; chart.data = []; chart.goal=null;
        } else {
          appData.charts.push({ id:'chart_'+Date.now(), name, type:'heatmap', dataLabel:label, heatmapData: heatmapTempData, data:[], goal:null });
        }
      } else {
        const goalVal = document.getElementById('dailyGoal').value;
        const goal = goalVal ? parseFloat(goalVal) : null;
        const label = document.getElementById('columnHeader').value || 'Value';
        const rows = Array.from(document.querySelectorAll('#dataTableBody tr'));
        const data = rows.map(r=>{
          const date = r.querySelector('input[type="date"]').value;
          const value = parseFloat(r.querySelector('input[type="number"]').value);
          return (date && !isNaN(value)) ? { date, value } : null;
        }).filter(Boolean).sort((a,b)=> new Date(a.date) - new Date(b.date));

        if (currentEditingChart) {
          const chart = appData.charts.find(c=>c.id===currentEditingChart);
          chart.name=name; chart.type=selectedChartType; chart.goal=goal; chart.dataLabel=label; chart.data=data; chart.heatmapData=[];
        } else {
          appData.charts.push({ id:'chart_'+Date.now(), name, type:selectedChartType, goal, dataLabel:label, data, heatmapData:[] });
        }
      }

      await saveData();
      closeChartModal();
      updateDashboard();
    }

    async function deleteChart(chartId){
      const chart = appData.charts.find(c=>c.id===chartId);
      if (!chart) return;
      if (chart.permanent) { alert('This tracker cannot be deleted'); return; }
      if (!confirm('Delete this chart?')) return;
      appData.charts = appData.charts.filter(c=>c.id!==chartId);
      await saveData();
      updateDashboard();
      updateCalorieTracker();
    }

    /* ============================
       Meal tracker functions & coloring logic
       ============================ */
    function addMealEntry(mealType, time, calories){
      if (!mealType || !time || !calories) return;
      const mealTracker = appData.charts.find(c=>c.id==='meal_tracker');
      if (!mealTracker) return;
      if (!mealTracker.mealData) mealTracker.mealData = [];
      const today = new Date().toISOString().split('T')[0];
      mealTracker.mealData.push({ date: today, time, type:mealType, calories: parseFloat(calories) });
      saveData();
      updateMealTracker();
      updateCalorieTracker();
      updateProgressBar();
    }

    function minutesDiff(t1, t2){
      const [h1,m1] = t1.split(':').map(Number);
      const [h2,m2] = t2.split(':').map(Number);
      return Math.abs((h1*60+m1) - (h2*60+m2));
    }

    function updateMealTracker(){
      // find meal tracker card in DOM
      const mealCard = document.querySelector('.meal-tracker-card');
      // if not present, render dashboard to ensure it's created
      if (!mealCard) { updateDashboard(); return; }

      const mealTracker = appData.charts.find(c=>c.id==='meal_tracker');
      const today = new Date().toISOString().split('T')[0];
      const todayMeals = (mealTracker?.mealData || []).filter(m=>m.date===today);

      // timeline markers
      const timeline = mealCard.querySelector('.meal-timeline');
      timeline.querySelectorAll('.meal-marker').forEach(n => n.remove());

      todayMeals.forEach(meal=>{
        const marker = document.createElement('div');
        marker.className = 'meal-marker';
        const [hours, minutes] = meal.time.split(':').map(Number);
        const totalMinutes = hours*60 + minutes;
        const leftPercent = (totalMinutes / 1440) * 100;
        marker.style.left = leftPercent + '%';
        marker.style.top = '50%';
        marker.title = `${meal.type} — ${meal.calories} kcal at ${meal.time}`;

        // coloring logic:
        // - snacks always yellow
        // - for breakfast/lunch/dinner: <=15min => standard orange, >15 && <=60 => dark orange, >60 => red
        if (meal.type === 'snack') {
          marker.style.background = 'var(--warning)';
        } else {
          const ideal = appData.idealMealTimes?.[meal.type] || (meal.type==='breakfast'?'08:30': meal.type==='lunch'?'13:00':'18:00');
          const diff = minutesDiff(meal.time, ideal);
          if (diff <= 15) marker.style.background = 'var(--orange)';
          else if (diff <= 60) marker.style.background = 'var(--dark-orange)';
          else marker.style.background = 'var(--danger)';
        }

        timeline.appendChild(marker);
      });

      // breakdown boxes (if present)
      ['breakfast','lunch','dinner','snack'].forEach(type=>{
        const el = mealCard.querySelector(`#${type}Calories`);
        if (!el) return;
        const sum = todayMeals.filter(m=>m.type===type).reduce((s,m)=>s+m.calories,0);
        el.textContent = Math.round(sum);
      });
    }

    /* ============================
       Calorie tracker functions
       ============================ */
    function updateCalorieTracker(){
      const today = new Date().toISOString().split('T')[0];
      const mealTracker = appData.charts.find(c=>c.id==='meal_tracker');
      let caloriesIn = (mealTracker?.mealData || []).filter(m=>m.date===today).reduce((s,m)=>s+m.calories,0);

      let caloriesOut = 0;
      const calorieChart = appData.charts.find(c=>c.id==='calories_burned');
      const todayBurn = calorieChart?.data?.find(d=>d.date===today);
      if (todayBurn) caloriesOut = todayBurn.value;

      document.getElementById('caloriesIn').textContent = Math.round(caloriesIn);
      document.getElementById('caloriesOut').textContent = Math.round(caloriesOut);

      const net = caloriesIn - caloriesOut;
      const netEl = document.getElementById('netCalories');
      const netStatEl = document.getElementById('netCaloriesStat');
      if (net < (appData.dailyCalorieTarget || 2000)) {
        const deficit = (appData.dailyCalorieTarget || 2000) - net;
        netEl.textContent = `-${Math.round(deficit)}`;
        netStatEl.classList.add('deficit'); netStatEl.classList.remove('surplus');
      } else {
        const surplus = net - (appData.dailyCalorieTarget || 2000);
        netEl.textContent = `+${Math.round(surplus)}`;
        netStatEl.classList.remove('deficit'); netStatEl.classList.add('surplus');
      }

      document.getElementById('dailyTarget').textContent = appData.dailyCalorieTarget || 2000;
    }

    async function saveCaloriesBurnedFromTracker(){
      const val = parseFloat(document.getElementById('trackerCaloriesBurnedInput').value);
      if (isNaN(val)) { alert('Enter a valid number for calories burned'); return; }
      const today = new Date().toISOString().split('T')[0];
      const chart = appData.charts.find(c=>c.id==='calories_burned');
      if (!chart.data) chart.data = [];
      const idx = chart.data.findIndex(d=>d.date===today);
      if (idx !== -1) chart.data[idx].value = val;
      else chart.data.push({ date:today, value:val });
      chart.data.sort((a,b)=> new Date(a.date) - new Date(b.date));
      await saveData();
      updateCalorieTracker();
      updateProgressBar();
      document.getElementById('trackerCaloriesBurnedInput').value = '';
    }
    function clearTrackerBurnInput(){ document.getElementById('trackerCaloriesBurnedInput').value=''; }

    /* ============================
       Progress calculations
       ============================ */
    function updateProgressBar(){
      if (!appData.currentWeight || !appData.targetWeight) return;
      const kgToLose = Math.max(0, appData.currentWeight - appData.targetWeight);
      const totalDeficitNeeded = kgToLose * 7000; // kcal per kg

      // calculate achieved across dates in data
      let totalDeficitAchieved = 0;
      const mealTracker = appData.charts.find(c=>c.id==='meal_tracker');
      const calorieChart = appData.charts.find(c=>c.id==='calories_burned');

      const dates = new Set();
      (mealTracker?.mealData || []).forEach(m=>dates.add(m.date));
      (calorieChart?.data || []).forEach(d=>dates.add(d.date));

      dates.forEach(date=>{
        const inCals = (mealTracker?.mealData || []).filter(m=>m.date===date).reduce((s,m)=>s+m.calories,0);
        const outCals = (calorieChart?.data || []).find(d=>d.date===date)?.value || 0;
        const dayNet = inCals - outCals;
        if (dayNet < (appData.dailyCalorieTarget || 2000)) totalDeficitAchieved += ((appData.dailyCalorieTarget || 2000) - dayNet);
      });

      const remaining = Math.max(0, totalDeficitNeeded - totalDeficitAchieved);
      const percent = totalDeficitNeeded === 0 ? 0 : Math.min(100, (totalDeficitAchieved / totalDeficitNeeded) * 100);

      document.getElementById('totalDeficitNeeded').textContent = Math.round(totalDeficitNeeded).toLocaleString();
      document.getElementById('deficitAchieved').textContent = Math.round(totalDeficitAchieved).toLocaleString();
      document.getElementById('deficitRemaining').textContent = Math.round(remaining).toLocaleString();
      document.getElementById('progressPercentage').textContent = Math.round(percent);

      // fill progress cells
      const cells = document.getElementById('progressCells');
      const filled = Math.round((percent/100) * 20);
      cells.innerHTML = '';
      for (let i=0;i<20;i++){
        const div = document.createElement('div');
        div.className = 'progress-cell' + (i<filled ? ' filled' : '');
        cells.appendChild(div);
      }
    }

    /* ============================
       Dashboard rendering
       ============================ */
    function updateDashboard(){
      const container = document.getElementById('dashboardContent');
      container.innerHTML = ''; // clear

      // ensure meal tracker card is first (permanent)
      const mealCard = createMealTrackerCard();
      container.appendChild(mealCard);

      // other charts
      (appData.charts || []).forEach(chart=>{
        if (chart.id === 'meal_tracker') return; // already added
        const card = createChartCard(chart);
        container.appendChild(card);
      });

      // subtitle
      const customCharts = (appData.charts||[]).filter(c=>!c.permanent).length;
      document.getElementById('dashboardSubtitle').textContent = customCharts ? `Tracking ${customCharts} metric${customCharts!==1?'s':''}` : 'Start tracking your personal metrics';
      updateMealTracker();
    }

    function createMealTrackerCard(){
      const card = document.createElement('div');
      card.className = 'meal-tracker-card chart-card';
      card.id = 'meal_tracker_card';

      card.innerHTML = `
        <div class="chart-header"><div class="chart-title">Meal & Exercise Tracker</div></div>
        <div class="meal-input-section">
          <select id="mealTypeInput" class="meal-type-select">
            <option value="breakfast">Breakfast</option>
            <option value="lunch">Lunch</option>
            <option value="dinner">Dinner</option>
            <option value="snack">Snack</option>
          </select>
          <input id="mealTimeInput" class="meal-time-input" type="time" value="${appData.idealMealTimes?.breakfast || '08:30'}" />
          <input id="mealCalorieInput" class="meal-calorie-input" type="number" placeholder="Calories" />
          <button class="add-meal-btn" onclick="addMealQuick()">Add</button>
        </div>

        <div class="meal-visualizations">
          <div class="meal-viz-section">
            <div class="meal-viz-title">Meal Timeline (Today)</div>
            <div class="meal-timeline"><div class="meal-timeline-axis"></div></div>
            <div class="time-labels"><span>12AM</span><span>6AM</span><span>12PM</span><span>6PM</span><span>12AM</span></div>
          </div>

          <div class="meal-viz-section">
            <div class="meal-viz-title">Calorie Breakdown</div>
            <div>
              <div class="meal-category"><div class="meal-category-name">🌅 Breakfast</div><div class="meal-category-calories" id="breakfastCalories">0</div></div>
              <div class="meal-category"><div class="meal-category-name">☀️ Lunch</div><div class="meal-category-calories" id="lunchCalories">0</div></div>
              <div class="meal-category"><div class="meal-category-name">🌙 Dinner</div><div class="meal-category-calories" id="dinnerCalories">0</div></div>
              <div class="meal-category"><div class="meal-category-name">🍿 Snacks</div><div class="meal-category-calories" id="snackCalories">0</div></div>
            </div>
          </div>
        </div>
      `;
      return card;
    }

    function addMealQuick(){
      const type = document.getElementById('mealTypeInput').value;
      const time = document.getElementById('mealTimeInput').value;
      const calories = parseFloat(document.getElementById('mealCalorieInput').value);
      if (!time || isNaN(calories)) { alert('Please enter time and calories'); return; }
      addMealEntry(type, time, calories);
      document.getElementById('mealCalorieInput').value = '';
    }

    function createChartCard(chart){
      const card = document.createElement('div');
      card.className = 'chart-card';

      // menu id for dropdown
      const menuId = `menu_${chart.id}`;

      if (chart.type === 'heatmap') {
        card.innerHTML = `
          <div class="chart-header">
            <div class="chart-title">${chart.name}</div>
            <div style="position:relative;">
              <button class="menu-dots" onclick="toggleMenu('${menuId}')">⋯</button>
              <div id="${menuId}" class="menu-dropdown">
                <button class="menu-item" onclick="openEditModal('${chart.id}')">Edit Chart</button>
                <button class="menu-item" onclick="deleteChart('${chart.id}')">Delete Chart</button>
              </div>
            </div>
          </div>
          <div id="heatmap_${chart.id}"></div>
        `;
        // render simple heatmap after insertion
        setTimeout(()=> renderHeatmapSimple(chart), 80);
        return card;
      }

      const latest = (chart.data && chart.data.length) ? chart.data[chart.data.length-1].value : 0;
      const prev = (chart.data && chart.data.length>1) ? chart.data[chart.data.length-2].value : null;
      let trend = '';
      if (prev !== null && prev !== 0) trend = `${((latest-prev)/prev*100).toFixed(1)}%`;

      card.innerHTML = `
        <div class="chart-header">
          <div class="chart-title">${chart.name}</div>
          <div style="position:relative;">
            <button class="menu-dots" onclick="toggleMenu('${menuId}')">⋯</button>
            <div id="${menuId}" class="menu-dropdown">
              <button class="menu-item" onclick="openEditModal('${chart.id}')">Edit Chart</button>
              <button class="menu-item" onclick="deleteChart('${chart.id}')">Delete Chart</button>
            </div>
          </div>
        </div>
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
          <div class="chart-value">${latest}</div>
          <div style="font-size:12px; color:var(--subtext)">${chart.dataLabel || ''}${trend ? ` • ${trend}` : ''}</div>
        </div>
        <div class="chart-container"><canvas id="canvas_${chart.id}"></canvas></div>
      `;
      setTimeout(()=> renderChartJS(chart), 80);
      return card;
    }

    function toggleMenu(id){
      document.querySelectorAll('.menu-dropdown').forEach(d => { if (d.id !== id) d.classList.remove('active'); });
      const el = document.getElementById(id); if (el) el.classList.toggle('active');
    }

    /* ============================
       Chart rendering helpers
       ============================ */
    function renderChartJS(chart){
      const ctx = document.getElementById(`canvas_${chart.id}`);
      if (!ctx) return;
      const labels = (chart.data || []).map(d => d.date);
      const values = (chart.data || []).map(d => d.value);
      const config = {
        type: chart.type === 'line' ? 'line' : 'bar',
        data: {
          labels,
          datasets: [{
            label: chart.dataLabel || 'Value',
            data: values,
            borderColor: 'rgba(252,76,2,0.95)',
            backgroundColor: chart.type === 'bar' ? 'rgba(252,76,2,0.9)' : 'rgba(252,76,2,0.12)',
            tension: 0.35,
            borderWidth: 2,
            pointRadius: 3
          }]
        },
        options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}} }
      };
      try { new Chart(ctx, config); } catch(e){ console.error('Chart render error', e); }
    }

    function renderHeatmapSimple(chart){
      const container = document.getElementById(`heatmap_${chart.id}`);
      if (!container) return;
      const entries = chart.heatmapData || [];
      // create a minimal 7x24 grid for the current week
      // This is a simple visual - for production consider a proper grid/chart lib
      const htmlParts = ['<div style="overflow:auto;"><table style="border-collapse:collapse;">'];
      htmlParts.push('<thead><tr><th></th><th style="padding:6px;">SUN</th><th style="padding:6px;">MON</th><th style="padding:6px;">TUE</th><th style="padding:6px;">WED</th><th style="padding:6px;">THU</th><th style="padding:6px;">FRI</th><th style="padding:6px;">SAT</th></tr></thead><tbody>');
      const maxIntensity = entries.reduce((m,e)=> Math.max(m, e.intensity||0), 1);
      for (let hour=0; hour<24; hour++){
        htmlParts.push(`<tr><td style="padding:6px; color:var(--subtext)">${hour}:00</td>`);
        for (let d=0; d<7; d++){
          const cellEntry = entries.find(e => { const dt=new Date(e.datetime); return dt.getHours()===hour && dt.getDay()===d; });
          if (!cellEntry) htmlParts.push(`<td style="width:34px; height:18px; background:var(--dark); border:1px solid var(--border)"></td>`);
          else {
            const opacity = Math.max(0.15, (cellEntry.intensity / maxIntensity));
            htmlParts.push(`<td style="width:34px; height:18px; background:rgba(252,76,2,${opacity}); border:1px solid var(--border)"></td>`);
          }
        }
        htmlParts.push('</tr>');
      }
      htmlParts.push('</tbody></table></div>');
      container.innerHTML = htmlParts.join('');
    }

    /* ============================
       Utility: edit modal loader
       ============================ */
    function openEditModal(chartId){
      const chart = appData.charts.find(c=>c.id===chartId);
      if (!chart || chart.permanent) return;
      currentEditingChart = chartId;
      document.getElementById('modalTitle').textContent = 'Edit Chart';
      document.getElementById('chartName').value = chart.name;
      document.getElementById('dailyGoal').value = chart.goal || '';
      document.getElementById('columnHeader').value = chart.dataLabel || 'Value';
      selectedChartType = chart.type;
      updateChartTypeButtons();
      updateDataEntryVisibility();

      if (chart.type === 'heatmap') {
        heatmapTempData = chart.heatmapData ? [...chart.heatmapData] : [];
        updateHeatmapEntriesList();
      } else {
        const body = document.getElementById('dataTableBody');
        body.innerHTML = '';
        (chart.data || []).forEach(r => addDataRow(r.date, r.value));
        if ((chart.data||[]).length === 0) addDataRow();
      }

      document.getElementById('chartModal').classList.add('active');
    }

    /* ============================
       Startup & expose functions for onclicks
       ============================ */
    window.openAddModal = openAddModal;
    window.openSettingsModal = openSettingsModal;
    window.closeSettingsModal = closeSettingsModal;
    window.saveSettings = saveSettings;
    window.skipSetup = skipSetup;
    window.setTarget = setTarget;
    window.openDailyUpdateModal = openDailyUpdateModal;
    window.closeDailyUpdateModal = closeDailyUpdateModal;
    window.saveDailyUpdate = saveDailyUpdate;
    window.selectChartType = selectChartType;
    window.addDataRow = addDataRow;
    window.addHeatmapEntry = addHeatmapEntry;
    window.addMealQuick = addMealQuick;
    window.openEditModal = openEditModal;
    window.closeChartModal = closeChartModal;
    window.saveChart = saveChart;
    window.deleteChart = deleteChart;
    window.saveCaloriesBurnedFromTracker = saveCaloriesBurnedFromTracker;
    window.clearTrackerBurnInput = clearTrackerBurnInput;
    window.toggleMenu = toggleMenu;

    // Kick off app
    init();
  </script>
</body>
</html>
