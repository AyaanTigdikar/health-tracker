<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>PERFORMANCE - Health Dashboard</title>

    <!-- Chart.js and date-fns -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/date-fns/2.30.0/index.min.js"></script>

    <!-- Ubuntu font -->
    <link rel="preconnect" href="https://fonts.googleapis.com"/>
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin/>
    <link href="https://fonts.googleapis.com/css2?family=Ubuntu:wght@300;400;500;700&display=swap" rel="stylesheet"/>

    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        :root{
            --strava-orange:#FC4C02;
            --strava-dark:#0D0D0D;
            --strava-gray:#1C1C1C;
            --strava-light-gray:#2D2D2D;
            --strava-border:#333333;
            --strava-text:#FFFFFF;
            --strava-text-secondary:#999999;
            --success-green:#00D964;
            --warning-yellow:#FFB700;
            --danger-red:#CC3300;
            --dark-orange:#E54502;
        }

        body {
            font-family: 'Ubuntu', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--strava-dark);
            color: var(--strava-text);
            min-height:100vh;
            overflow-x:hidden;
        }

        .app-container{ display:flex; height:100vh; overflow:hidden; }

        /* Sidebar */
        .sidebar{
            width:280px; background:var(--strava-gray);
            border-right:1px solid var(--strava-border);
            display:flex; flex-direction:column; padding:30px 20px;
        }
        .app-logo{ font-size:24px; font-weight:700; color:var(--strava-orange); display:flex; gap:10px; align-items:center; }
        .app-tagline{ font-size:11px; color:var(--strava-text-secondary); margin-top:5px; text-transform:uppercase; letter-spacing:1px; }

        .target-widget{ background:var(--strava-light-gray); border-radius:12px; padding:20px; margin-bottom:30px; border:1px solid var(--strava-border); }
        .target-label{ font-size:11px; color:var(--strava-text-secondary); text-transform:uppercase; letter-spacing:1px; margin-bottom:8px; font-weight:500; }
        .target-date-display{ font-size:18px; font-weight:500; color:var(--strava-text); margin-bottom:15px; }
        .countdown-display{ background:var(--strava-orange); color:white; padding:12px; border-radius:8px; text-align:center; font-weight:700; font-size:16px; }

        .sync-indicator{ display:flex; gap:8px; align-items:center; padding:12px; background:var(--strava-light-gray); border-radius:8px; margin-bottom:30px; border:1px solid var(--strava-border); font-size:13px; }
        .sync-indicator.syncing { border-color:var(--strava-orange); color:var(--strava-orange); }
        .sync-indicator.synced { border-color:var(--success-green); color:var(--success-green); }
        .sync-indicator.error { border-color:var(--warning-yellow); color:var(--warning-yellow); }

        .action-buttons{ display:flex; flex-direction:column; gap:10px; margin-top:auto; }
        .btn-primary{ background:var(--strava-orange); color:white; border:none; padding:14px 20px; border-radius:8px; font-size:14px; font-weight:500; cursor:pointer; text-transform:uppercase; letter-spacing:0.5px; }
        .btn-secondary{ background:transparent; color:var(--strava-text-secondary); border:1px solid var(--strava-border); padding:14px 20px; border-radius:8px; cursor:pointer; }

        /* Main */
        .main-content{ flex:1; overflow-y:auto; padding:30px; background:var(--strava-dark); }
        .dashboard-header{ margin-bottom:30px; }
        .dashboard-title{ font-size:32px; font-weight:700; color:var(--strava-text); margin-bottom:8px; }
        .dashboard-subtitle{ font-size:14px; color:var(--strava-text-secondary); }

        .dashboard-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(380px, 1fr)); gap:20px; grid-auto-flow:dense; }

        .chart-card{ background:var(--strava-gray); border:1px solid var(--strava-border); border-radius:12px; padding:20px; position:relative; }
        .chart-card.large{ grid-column:span 2; }
        .chart-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .chart-title{ font-size:16px; font-weight:700; color:var(--strava-text); text-transform:uppercase; letter-spacing:0.5px; }
        .menu-dots{ width:32px; height:32px; border-radius:50%; border:1px solid var(--strava-border); color:var(--strava-text-secondary); display:flex; align-items:center; justify-content:center; cursor:pointer; }

        /* Calorie tracker */
        .calorie-tracker{ background:var(--strava-gray); border:1px solid var(--strava-border); border-radius:12px; padding:20px; margin-bottom:20px; }
        .calorie-header{ display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }
        .calorie-title{ font-size:18px; font-weight:700; color:var(--strava-text); text-transform:uppercase; letter-spacing:0.5px; }
        .calorie-stats{ display:grid; grid-template-columns:repeat(4,1fr); gap:15px; margin-bottom:20px; }
        .calorie-stat{ background:var(--strava-dark); padding:15px; border-radius:8px; text-align:center; }
        .calorie-stat-value{ font-size:24px; font-weight:700; color:var(--strava-orange); margin-bottom:5px; }
        .calorie-stat-label{ font-size:10px; color:var(--strava-text-secondary); text-transform:uppercase; letter-spacing:0.5px; }

        .progress-section{ background:var(--strava-dark); padding:20px; border-radius:8px; margin-bottom:15px; }
        .progress-bar-container{ background:var(--strava-gray); border-radius:8px; padding:4px; margin-bottom:10px; }
        .progress-bar-cells{ display:grid; grid-template-columns:repeat(20,1fr); gap:2px; height:20px; }
        .progress-cell{ background:var(--strava-light-gray); border-radius:2px; }
        .progress-cell.filled{ background:var(--strava-orange); box-shadow:0 0 5px rgba(252,76,2,0.3); }

        /* Meal tracker */
        .meal-tracker-card{ background:var(--strava-gray); border:2px solid var(--strava-orange); border-radius:12px; padding:20px; position:relative; grid-column:span 2; }
        .meal-tracker-card::before{ content:'DEFAULT TRACKER'; position:absolute; top:-10px; left:20px; background:var(--strava-orange); color:white; padding:2px 10px; border-radius:4px; font-size:10px; font-weight:700; letter-spacing:1px; }

        .meal-input-section{ display:grid; grid-template-columns:2fr 1fr 1fr auto; gap:10px; margin-bottom:15px; padding:15px; background:var(--strava-dark); border-radius:8px; }
        .meal-type-select, .meal-time-input, .meal-calorie-input { padding:10px; background:var(--strava-light-gray); border:1px solid var(--strava-border); color:var(--strava-text); border-radius:6px; font-size:14px; }
        .add-meal-btn{ padding:10px 20px; background:var(--strava-orange); color:white; border:none; border-radius:6px; cursor:pointer; }

        .meal-viz-section{ background:var(--strava-dark); padding:15px; border-radius:8px; }
        .meal-timeline{ position:relative; height:200px; }
        .meal-timeline-axis{ position:absolute; left:0; right:0; height:2px; background:var(--strava-border); top:50%; }
        .meal-marker{ position:absolute; width:12px; height:12px; border-radius:50%; border:2px solid var(--strava-dark); transform:translate(-50%,-50%); transition:all 0.2s ease; cursor:pointer; }
        .time-labels{ display:flex; justify-content:space-between; margin-top:10px; font-size:10px; color:var(--strava-text-secondary); }

        .meal-category{ display:flex; justify-content:space-between; align-items:center; padding:10px; background:var(--strava-gray); border-radius:6px; margin-bottom:8px; }
        .meal-category-calories{ font-size:18px; font-weight:700; color:var(--strava-orange); }

        /* Modal styles (simple) */
        .modal{ display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; align-items:center; justify-content:center; }
        .modal.active{ display:flex; }
        .modal-content{ background:var(--strava-gray); border:1px solid var(--strava-border); border-radius:16px; padding:40px; max-width:700px; width:94%; max-height:85vh; overflow-y:auto; position:relative; }

        /* small inputs inside calorie-tracker */
        .burn-input-row{ display:flex; gap:8px; align-items:center; margin-top:8px; }
        .small-input{ padding:8px 10px; background:var(--strava-dark); border:1px solid var(--strava-border); border-radius:6px; color:var(--strava-text); width:120px; }

        /* minimal responsive tweaks */
        @media (max-width:900px){
            .meal-tracker-card { grid-column:span 1; }
        }
    </style>
</head>
<body onload="init()">
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="logo-section">
                <div class="app-logo">
                    <span>💪</span>
                    <span>PERFORMANCE</span>
                </div>
                <div class="app-tagline">Track • Analyze • Achieve</div>
            </div>

            <div class="target-widget">
                <div class="target-label">Target Date</div>
                <div class="target-date-display" id="targetDisplay">Not Set</div>
                <div class="countdown-display" id="countdown">Set Your Goal</div>
            </div>

            <div class="sync-indicator" id="syncStatus">
                <span id="syncIcon">🔄</span>
                <span id="syncText">Checking...</span>
            </div>

            <div class="action-buttons">
                <button class="btn-primary" onclick="openAddModal()">+ Add Chart</button>
                <button class="btn-secondary" onclick="openSettingsModal()">⚙️ Settings</button>
            </div>
        </div>

        <!-- Main content -->
        <div class="main-content">
            <!-- Calorie tracker -->
            <div id="calorieTracker" class="calorie-tracker">
                <div class="calorie-header">
                    <h2 class="calorie-title">Daily Calorie Balance</h2>
                    <span id="todayDate"></span>
                </div>

                <div class="calorie-stats">
                    <div class="calorie-stat">
                        <div class="calorie-stat-value" id="caloriesIn">0</div>
                        <div class="calorie-stat-label">Calories In</div>
                    </div>
                    <div class="calorie-stat">
                        <div class="calorie-stat-value" id="caloriesOut">0</div>
                        <div class="calorie-stat-label">Calories Burned</div>
                    </div>
                    <div class="calorie-stat" id="netCaloriesStat">
                        <div class="calorie-stat-value" id="netCalories">0</div>
                        <div class="calorie-stat-label">Net Balance</div>
                    </div>
                    <div class="calorie-stat">
                        <div class="calorie-stat-value" id="dailyTarget">2000</div>
                        <div class="calorie-stat-label">Daily Target</div>
                    </div>
                </div>

                <!-- Add calories burned quickly from the tracker (this is now in the default tracker, not the quick-update modal) -->
                <div class="burn-input-row">
                    <input id="trackerCaloriesBurnedInput" class="small-input" type="number" placeholder="Calories burned"/>
                    <button class="btn-primary" style="padding:8px 12px; font-size:13px;" onclick="saveCaloriesBurnedFromTracker()">Save Burn</button>
                    <button class="btn-secondary" style="padding:8px 12px; font-size:13px;" onclick="clearTrackerBurnInput()">Clear</button>
                </div>

                <div class="progress-section">
                    <div class="progress-title">Weight Goal Progress</div>
                    <div class="progress-bar-container">
                        <div class="progress-bar-cells" id="progressCells"></div>
                    </div>
                    <div class="progress-info" style="display:flex; justify-content:space-between;">
                        <span>Total Deficit Needed: <span id="totalDeficitNeeded">0</span> kcal</span>
                        <span class="progress-percentage"><span id="progressPercentage">0</span>% Complete</span>
                    </div>
                    <div class="progress-info" style="margin-top:10px; display:flex; justify-content:space-between;">
                        <span>Deficit Achieved: <span id="deficitAchieved" style="color:var(--success-green);">0</span> kcal</span>
                        <span>Remaining: <span id="deficitRemaining" style="color:var(--strava-orange);">0</span> kcal</span>
                    </div>
                </div>
            </div>

            <div class="dashboard-header">
                <h1 class="dashboard-title">Your Dashboard</h1>
                <p class="dashboard-subtitle" id="dashboardSubtitle">Loading your performance data...</p>
            </div>

            <div id="dashboardContent"></div>
        </div>
    </div>

    <!-- Floating daily update button -->
    <button class="daily-update-btn" onclick="openDailyUpdateModal()" title="Add Daily Update">📊</button>

    <!-- SETTINGS modal (combined weight goals, meal times, GitHub) -->
    <div id="settingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Settings</h2>
                <p class="modal-subtitle">Configure goals, meal times and GitHub sync</p>
            </div>

            <!-- Weight Goals -->
            <h3 style="color:var(--strava-text); margin-bottom:10px;">Weight Goals</h3>
            <div class="form-group">
                <label class="form-label">Target Date</label>
                <input type="date" id="settingsTargetDate" class="small-input" />
            </div>
            <div class="form-group">
                <label class="form-label">Current Weight (kg)</label>
                <input type="number" id="settingsCurrentWeight" class="small-input" step="0.1" />
            </div>
            <div class="form-group">
                <label class="form-label">Target Weight (kg)</label>
                <input type="number" id="settingsTargetWeight" class="small-input" step="0.1" />
            </div>
            <div class="form-group">
                <label class="form-label">Daily Calorie Target</label>
                <input type="number" id="settingsDailyCalories" class="small-input" />
            </div>

            <!-- Meal times -->
            <h3 style="color:var(--strava-text); margin-top:20px; margin-bottom:10px;">Ideal Meal Times</h3>
            <div style="display:grid; grid-template-columns:repeat(3,1fr); gap:12px;">
                <div>
                    <label class="form-label">Breakfast</label>
                    <input type="time" id="settingsBreakfast" class="small-input" />
                </div>
                <div>
                    <label class="form-label">Lunch</label>
                    <input type="time" id="settingsLunch" class="small-input" />
                </div>
                <div>
                    <label class="form-label">Dinner</label>
                    <input type="time" id="settingsDinner" class="small-input" />
                </div>
            </div>

            <!-- GitHub -->
            <h3 style="color:var(--strava-text); margin-top:20px; margin-bottom:10px;">GitHub Sync</h3>
            <div class="form-group">
                <label class="form-label">GitHub Personal Access Token</label>
                <input type="password" id="settingsGithubToken" class="small-input" placeholder="ghp_xxxxx"/>
                <div class="form-hint" style="color:var(--strava-text-secondary); font-size:12px; margin-top:6px;">
                    Need a token? <a href="https://github.com/settings/tokens/new?scopes=repo" target="_blank" style="color:var(--strava-orange);">Create one</a> with 'repo' scope
                </div>
            </div>
            <div class="form-group">
                <label class="form-label">GitHub Username</label>
                <input type="text" id="settingsGithubUsername" class="small-input" />
            </div>
            <div class="form-group">
                <label class="form-label">Repository Name</label>
                <input type="text" id="settingsGithubRepo" class="small-input" placeholder="health-tracker"/>
            </div>
            <div class="form-group">
                <label class="form-label">Branch</label>
                <input type="text" id="settingsGithubBranch" class="small-input" value="main"/>
            </div>

            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn-secondary" onclick="closeSettingsModal()">Cancel</button>
                <button class="btn-primary" onclick="saveSettings()">Save Settings</button>
            </div>
        </div>
    </div>

    <!-- INITIAL setup modal -->
    <div id="setupModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Welcome to PERFORMANCE</h2>
                <p class="modal-subtitle">Let's set up your fitness goals</p>
            </div>

            <div class="form-group">
                <label class="form-label">Target Date</label>
                <input type="date" id="targetDateInput" class="small-input"/>
            </div>
            <div class="form-group">
                <label class="form-label">Current Weight (kg)</label>
                <input type="number" id="currentWeightInput" class="small-input" step="0.1"/>
            </div>
            <div class="form-group">
                <label class="form-label">Target Weight (kg)</label>
                <input type="number" id="targetWeightInput" class="small-input" step="0.1"/>
            </div>
            <div class="form-group">
                <label class="form-label">Daily Calorie Target</label>
                <input type="number" id="dailyCalorieInput" class="small-input" value="2000"/>
            </div>

            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn-secondary" onclick="skipSetup()">Skip for Now</button>
                <button class="btn-primary" onclick="setTarget()">Set Targets</button>
            </div>
        </div>
    </div>

    <!-- DAILY update modal (no calories burned input here anymore) -->
    <div id="dailyUpdateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Daily Update</h2>
                <p class="modal-subtitle">Quick entry for today's metrics</p>
            </div>

            <div id="dailyUpdateCharts"></div>

            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn-secondary" onclick="closeDailyUpdateModal()">Cancel</button>
                <button class="btn-primary" onclick="saveDailyUpdate()">Save Update</button>
            </div>
        </div>
    </div>

    <!-- Add/Edit Chart Modal (unchanged structure) -->
    <div id="chartModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle" class="modal-title">Add New Chart</h2>
                <p class="modal-subtitle">Configure your tracking metrics</p>
            </div>

            <div class="form-group">
                <label class="form-label">Chart Name</label>
                <input type="text" id="chartName" class="small-input" placeholder="e.g., Daily Steps"/>
            </div>

            <div class="form-group">
                <label class="form-label">Chart Type</label>
                <div style="display:flex; gap:8px;">
                    <button class="btn-secondary chart-type-btn" onclick="selectChartType('line')">📈 LINE</button>
                    <button class="btn-secondary chart-type-btn" onclick="selectChartType('bar')">📊 BAR</button>
                    <button class="btn-secondary chart-type-btn" onclick="selectChartType('heatmap')">🌡️ HEATMAP</button>
                </div>
            </div>

            <div id="goalSection" class="form-group">
                <label class="form-label">Daily Goal (Optional)</label>
                <input type="number" id="dailyGoal" class="small-input" />
            </div>

            <div id="dataEntrySection" class="form-group">
                <label class="form-label">Data Entry</label>
                <table class="data-table" id="dataTable" style="width:100%; border-collapse:collapse; margin-top:10px;">
                    <thead>
                        <tr><th>Date</th><th><input id="columnHeader" value="Value" class="small-input" style="width:100%"/></th><th>Action</th></tr>
                    </thead>
                    <tbody id="dataTableBody"></tbody>
                </table>
                <button class="add-row-btn" onclick="addDataRow()">+ Add Row</button>
            </div>

            <div id="heatmapDataSection" class="form-group" style="display:none;">
                <label class="form-label">Heatmap Data Entry</label>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                    <input type="datetime-local" id="heatmapDateTime" class="small-input"/>
                    <input type="number" id="heatmapIntensity" class="small-input" placeholder="Intensity"/>
                </div>
                <button class="add-row-btn" onclick="addHeatmapEntry()">+ Add Entry</button>
                <div id="heatmapEntriesList" style="margin-top:12px; max-height:200px; overflow:auto; padding:10px; background:var(--strava-dark); border:1px solid var(--strava-border); border-radius:8px;">
                    <div style="color:var(--strava-text-secondary); text-align:center;">No entries yet</div>
                </div>
            </div>

            <div style="display:flex; gap:12px; margin-top:20px;">
                <button class="btn-secondary" onclick="closeModal()">Cancel</button>
                <button class="btn-primary" onclick="saveChart()">Save Chart</button>
            </div>
        </div>
    </div>

    <script>
    /***********************
     * App state & defaults
     ***********************/
    let githubConfig = { token:'', username:'', repo:'', branch:'main', useGithub:false };
    let lastSha = null;
    let currentEditingChart = null;
    let selectedChartType = 'line';
    let heatmapTempData = [];

    let appData = {
        targetDate: null,
        currentWeight: null,
        targetWeight: null,
        dailyCalorieTarget: 2000,
        // IMPORTANT: idealMealTimes stored here and editable in settings
        idealMealTimes: { breakfast: '08:30', lunch: '13:00', dinner: '18:00' },
        charts: []
    };

    // Chart.js font
    Chart.defaults.color = '#999999';
    Chart.defaults.borderColor = '#333333';
    Chart.defaults.font.family = "Ubuntu, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif";

    /***********************
     * Initialization
     ***********************/
    async function init(){
        loadGithubConfig();
        loadLocalData();

        // ensure trackers
        ensureMealTracker();
        ensureCaloriesBurnedChart();

        // populate UI
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('targetDateInput')?.setAttribute('min', today);
        document.getElementById('todayDate').textContent = new Date().toLocaleDateString('en-US', { weekday:'short', month:'short', day:'numeric' });

        if (!appData.targetDate){
            document.getElementById('setupModal').classList.add('active');
        } else {
            updateDashboard();
            startCountdown();
            updateCalorieTracker();
            updateProgressBar();
        }
    }

    /***********************
     * Ensure default trackers
     ***********************/
    function ensureMealTracker(){
        const mealTracker = appData.charts.find(c => c.id === 'meal_tracker');
        if (!mealTracker) {
            appData.charts.unshift({ id:'meal_tracker', name:'Meal Tracker', type:'meal', dataLabel:'Calories', mealData:[], permanent:true });
            saveLocalData();
        }
    }
    function ensureCaloriesBurnedChart(){
        const calorieChart = appData.charts.find(c => c.id === 'calories_burned');
        if (!calorieChart) {
            appData.charts.push({ id:'calories_burned', name:'Calories Burned', type:'bar', dataLabel:'Calories', data:[], goal:null, permanent:true });
            saveLocalData();
        }
    }

    /***********************
     * Load / Save GitHub config + data
     ***********************/
    function loadGithubConfig(){
        const saved = localStorage.getItem('githubConfig');
        if (saved) githubConfig = JSON.parse(saved);
    }

    async function loadFromGithub(){
        if (!githubConfig.token || !githubConfig.useGithub) return loadLocalData();

        updateSyncStatus('syncing','Syncing...');
        try {
            const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/health-data.json?ref=${githubConfig.branch}`;
            const resp = await fetch(url, { headers: { 'Authorization': `token ${githubConfig.token}`, 'Accept':'application/vnd.github.v3+json' }});
            if (resp.status === 404){
                updateSyncStatus('synced','GitHub Ready');
                return;
            }
            if (!resp.ok) throw new Error('GitHub API error ' + resp.status);
            const data = await resp.json();
            lastSha = data.sha;
            const content = atob(data.content);
            const parsed = JSON.parse(content);
            // merge to appData but keep defaults if missing
            appData = Object.assign({ idealMealTimes: { breakfast:'08:30', lunch:'13:00', dinner:'18:00' } }, parsed);
            localStorage.setItem('healthTrackerData', JSON.stringify(appData));
            updateSyncStatus('synced','GitHub Synced');
            updateDashboard();
            startCountdown();
        } catch (err){
            console.error('loadFromGithub failed', err);
            updateSyncStatus('error','Sync Failed');
            loadLocalData();
        }
    }

    async function saveToGithub(){
        if (!githubConfig.token || !githubConfig.useGithub) return saveLocalData();
        updateSyncStatus('syncing','Saving...');
        try {
            const url = `https://api.github.com/repos/${githubConfig.username}/${githubConfig.repo}/contents/health-data.json`;
            const content = btoa(JSON.stringify(appData, null, 2));
            const body = { message: `Update health data - ${new Date().toLocaleString()}`, content, branch: githubConfig.branch };
            if (lastSha) body.sha = lastSha;
            const resp = await fetch(url, { method:'PUT', headers:{ 'Authorization':`token ${githubConfig.token}`, 'Accept':'application/vnd.github.v3+json', 'Content-Type':'application/json' }, body: JSON.stringify(body) });
            if (!resp.ok) {
                const err = await resp.text();
                throw new Error('GitHub save error: ' + resp.status + ' ' + err);
            }
            const data = await resp.json();
            lastSha = data.content.sha;
            localStorage.setItem('healthTrackerData', JSON.stringify(appData));
            updateSyncStatus('synced','Saved to GitHub');
        } catch (err){
            console.error('saveToGithub failed', err);
            updateSyncStatus('error','Save Failed - Saved Locally');
            saveLocalData();
        }
    }

    function saveLocalData(){
        localStorage.setItem('healthTrackerData', JSON.stringify(appData));
        updateSyncStatus('offline','Saved Locally');
    }

    async function saveData(){
        if (githubConfig.useGithub) {
            await saveToGithub();
        } else {
            saveLocalData();
        }
    }

    function loadLocalData(){
        const saved = localStorage.getItem('healthTrackerData');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                appData = Object.assign({ idealMealTimes: { breakfast:'08:30', lunch:'13:00', dinner:'18:00' } }, parsed);
            } catch(e){ console.error('invalid local data', e); }
        }
    }

    function updateSyncStatus(status, text){
        const s = document.getElementById('syncStatus');
        const icon = document.getElementById('syncIcon');
        const txt = document.getElementById('syncText');
        s.className = 'sync-indicator';
        switch(status){
            case 'syncing': s.classList.add('syncing'); icon.innerHTML = '<span class="loading-spinner"></span>'; break;
            case 'synced': s.classList.add('synced'); icon.textContent = '✔'; break;
            case 'error': s.classList.add('error'); icon.textContent = '⚠️'; break;
            case 'offline': icon.textContent = '💾'; break;
        }
        txt.textContent = text;
    }

    /***********************
     * Settings modal
     ***********************/
    function openSettingsModal(){
        document.getElementById('settingsTargetDate').value = appData.targetDate || '';
        document.getElementById('settingsCurrentWeight').value = appData.currentWeight || '';
        document.getElementById('settingsTargetWeight').value = appData.targetWeight || '';
        document.getElementById('settingsDailyCalories').value = appData.dailyCalorieTarget || 2000;

        document.getElementById('settingsBreakfast').value = appData.idealMealTimes?.breakfast || '08:30';
        document.getElementById('settingsLunch').value = appData.idealMealTimes?.lunch || '13:00';
        document.getElementById('settingsDinner').value = appData.idealMealTimes?.dinner || '18:00';

        document.getElementById('settingsGithubToken').value = githubConfig.token || '';
        document.getElementById('settingsGithubUsername').value = githubConfig.username || '';
        document.getElementById('settingsGithubRepo').value = githubConfig.repo || '';
        document.getElementById('settingsGithubBranch').value = githubConfig.branch || 'main';

        document.getElementById('settingsModal').classList.add('active');
    }
    function closeSettingsModal(){ document.getElementById('settingsModal').classList.remove('active'); }

    async function saveSettings(){
        // weight & targets
        appData.targetDate = document.getElementById('settingsTargetDate').value || appData.targetDate;
        appData.currentWeight = parseFloat(document.getElementById('settingsCurrentWeight').value) || appData.currentWeight;
        appData.targetWeight = parseFloat(document.getElementById('settingsTargetWeight').value) || appData.targetWeight;
        appData.dailyCalorieTarget = parseFloat(document.getElementById('settingsDailyCalories').value) || appData.dailyCalorieTarget;

        // meal times
        appData.idealMealTimes = {
            breakfast: document.getElementById('settingsBreakfast').value || '08:30',
            lunch: document.getElementById('settingsLunch').value || '13:00',
            dinner: document.getElementById('settingsDinner').value || '18:00'
        };

        // github config
        const token = document.getElementById('settingsGithubToken').value.trim();
        const username = document.getElementById('settingsGithubUsername').value.trim();
        const repo = document.getElementById('settingsGithubRepo').value.trim();
        const branch = document.getElementById('settingsGithubBranch').value.trim() || 'main';
        if (token && username && repo){
            githubConfig = { token, username, repo, branch, useGithub:true };
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
        } else {
            // user might want to disable GitHub
            githubConfig.useGithub = false;
            localStorage.setItem('githubConfig', JSON.stringify(githubConfig));
        }

        await saveData();
        closeSettingsModal();
        updateDashboard();
        startCountdown();
        updateCalorieTracker();
        updateProgressBar();
    }

    /***********************
     * Initial target setup
     ***********************/
    async function setTarget(){
        const dateInput = document.getElementById('targetDateInput').value;
        const currentWeight = parseFloat(document.getElementById('currentWeightInput').value);
        const targetWeight = parseFloat(document.getElementById('targetWeightInput').value);
        const dailyCalories = parseFloat(document.getElementById('dailyCalorieInput').value) || 2000;
        if (!dateInput || !currentWeight || !targetWeight) { alert('Please fill required fields'); return; }
        appData.targetDate = dateInput;
        appData.currentWeight = currentWeight;
        appData.targetWeight = targetWeight;
        appData.dailyCalorieTarget = dailyCalories;
        await saveData();
        document.getElementById('setupModal').classList.remove('active');
        updateDashboard();
        startCountdown();
        updateCalorieTracker();
        updateProgressBar();
    }
    function skipSetup(){ document.getElementById('setupModal').classList.remove('active'); updateDashboard(); }

    /***********************
     * Countdown
     ***********************/
    function startCountdown(){
        updateCountdown();
        setInterval(updateCountdown, 1000*60);
    }
    function updateCountdown(){
        if (!appData.targetDate) { document.getElementById('targetDisplay').textContent='Not Set'; document.getElementById('countdown').textContent='Set Your Goal'; return; }
        const target = new Date(appData.targetDate);
        const now = new Date();
        const diff = target - now;
        document.getElementById('targetDisplay').textContent = target.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
        if (diff <= 0) { document.getElementById('countdown').textContent = '🏆 ACHIEVED!'; return; }
        const days = Math.floor(diff/(1000*60*60*24));
        document.getElementById('countdown').textContent = `${days} DAYS TO GO`;
    }

    /***********************
     * Daily update modal
     ***********************/
    function openDailyUpdateModal(){
        const today = new Date().toISOString().split('T')[0];
        const container = document.getElementById('dailyUpdateCharts');
        container.innerHTML = '';
        appData.charts.forEach(chart=>{
            if (chart.id !== 'meal_tracker' && chart.type !== 'heatmap' && chart.id !== 'calories_burned'){
                const todayData = (chart.data||[]).find(d=>d.date===today);
                const div = document.createElement('div');
                div.className = 'form-group';
                div.innerHTML = `<label class="form-label">${chart.name}</label>
                    <input type="number" class="small-input daily-chart-input" data-chart-id="${chart.id}" placeholder="Enter today's ${chart.dataLabel||'value'}" value="${todayData?todayData.value:''}">`;
                container.appendChild(div);
            }
        });
        document.getElementById('dailyUpdateModal').classList.add('active');
    }
    function closeDailyUpdateModal(){ document.getElementById('dailyUpdateModal').classList.remove('active'); }

    async function saveDailyUpdate(){
        const today = new Date().toISOString().split('T')[0];
        document.querySelectorAll('.daily-chart-input').forEach(input=>{
            const chartId = input.dataset.chartId;
            const value = parseFloat(input.value);
            if (!isNaN(value)){
                const chart = appData.charts.find(c=>c.id===chartId);
                if (chart){
                    if (!chart.data) chart.data = [];
                    const idx = chart.data.findIndex(d=>d.date===today);
                    if (idx!==-1) chart.data[idx].value = value;
                    else { chart.data.push({ date:today, value }); chart.data.sort((a,b)=>new Date(a.date)-new Date(b.date)); }
                }
            }
        });
        await saveData();
        updateDashboard();
        updateCalorieTracker();
        updateProgressBar();
        closeDailyUpdateModal();
    }

    /***********************
     * Add chart modal helpers (unchanged)
     ***********************/
    function openAddModal(){
        currentEditingChart = null; heatmapTempData=[];
        document.getElementById('modalTitle').textContent='Add New Chart';
        document.getElementById('chartName').value=''; document.getElementById('dailyGoal').value=''; document.getElementById('columnHeader').value='Value';
        document.getElementById('dataTableBody').innerHTML=''; document.getElementById('heatmapEntriesList').innerHTML='<div style="color:var(--strava-text-secondary);text-align:center;">No entries yet</div>';
        selectedChartType='line'; updateChartTypeButtons(); updateDataEntryVisibility(); addDataRow();
        const now = new Date(); now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); document.getElementById('heatmapDateTime').value = now.toISOString().slice(0,16);
        document.getElementById('chartModal').classList.add('active');
    }
    function openEditModal(chartId){
        const chart = appData.charts.find(c=>c.id===chartId); if (!chart || chart.permanent) return;
        currentEditingChart = chartId; document.getElementById('modalTitle').textContent='Edit Chart';
        document.getElementById('chartName').value=chart.name; document.getElementById('dailyGoal').value=chart.goal||''; document.getElementById('columnHeader').value=chart.dataLabel||'Value';
        selectedChartType = chart.type; updateChartTypeButtons(); updateDataEntryVisibility();
        if (chart.type==='heatmap'){ heatmapTempData = chart.heatmapData? [...chart.heatmapData] : []; updateHeatmapEntriesList(); }
        else { const tbody = document.getElementById('dataTableBody'); tbody.innerHTML=''; (chart.data||[]).forEach(r=>addDataRow(r.date,r.value)); if (!chart.data || chart.data.length===0) addDataRow(); }
        document.getElementById('chartModal').classList.add('active');
    }
    function closeModal(){ document.getElementById('chartModal').classList.remove('active'); }
    function selectChartType(type){ selectedChartType=type; updateChartTypeButtons(); updateDataEntryVisibility(); }
    function updateChartTypeButtons(){}
    function updateDataEntryVisibility(){
        const regular = document.getElementById('dataEntrySection');
        const heatmap = document.getElementById('heatmapDataSection');
        const goal = document.getElementById('goalSection');
        if (selectedChartType==='heatmap'){ regular.style.display='none'; heatmap.style.display='block'; goal.style.display='none'; }
        else { regular.style.display='block'; heatmap.style.display='none'; goal.style.display='block'; }
    }
    function addHeatmapEntry(){
        const dateTime = document.getElementById('heatmapDateTime').value;
        const intensity = document.getElementById('heatmapIntensity').value;
        if (!dateTime || !intensity) { alert('Please enter date/time and intensity'); return; }
        heatmapTempData.push({ datetime: dateTime, intensity: parseFloat(intensity) });
        updateHeatmapEntriesList();
        document.getElementById('heatmapIntensity').value='';
    }
    function updateHeatmapEntriesList(){
        const list = document.getElementById('heatmapEntriesList');
        if (!heatmapTempData || heatmapTempData.length===0){ list.innerHTML = '<div style="color:var(--strava-text-secondary);text-align:center;">No entries yet</div>'; return; }
        heatmapTempData.sort((a,b)=>new Date(a.datetime)-new Date(b.datetime));
        list.innerHTML = heatmapTempData.map((e,i)=>{
            const d = new Date(e.datetime);
            const fmt = d.toLocaleString('en-US', { month:'short', day:'numeric', hour:'2-digit', minute:'2-digit' });
            return `<div style="display:flex; justify-content:space-between; padding:8px; border-bottom:1px solid var(--strava-border);">
                <span style="color:var(--strava-text);">${fmt} - <strong style="color:var(--strava-orange);">${e.intensity}</strong></span>
                <button class="btn-secondary" onclick="removeHeatmapEntry(${i})" style="padding:6px 8px;">Remove</button>
            </div>`;
        }).join('');
    }
    function removeHeatmapEntry(i){ heatmapTempData.splice(i,1); updateHeatmapEntriesList(); }

    function addDataRow(date='', value=''){
        const tbody = document.getElementById('dataTableBody');
        const row = document.createElement('tr');
        const today = new Date().toISOString().split('T')[0];
        row.innerHTML = `
            <td><input type="date" class="data-date small-input" value="${date}" max="${today}"/></td>
            <td><input type="number" class="data-value small-input" value="${value}" placeholder="Value"/></td>
            <td><button class="btn-secondary" onclick="deleteDataRow(this)" style="padding:6px 8px;">Delete</button></td>
        `;
        tbody.appendChild(row);
    }
    function deleteDataRow(btn){ btn.closest('tr').remove(); }

    async function saveChart(){
        const name = document.getElementById('chartName').value.trim(); if (!name){ alert('Please enter a chart name'); return; }
        if (selectedChartType==='heatmap'){
            if (!heatmapTempData || heatmapTempData.length===0){ alert('Add at least one entry'); return; }
            const dataLabel = document.getElementById('columnHeader').value || 'Intensity';
            if (currentEditingChart){
                const chart = appData.charts.find(c=>c.id===currentEditingChart);
                chart.name = name; chart.type = 'heatmap'; chart.dataLabel = dataLabel; chart.heatmapData = heatmapTempData; chart.data=[];
            } else {
                appData.charts.push({ id:'chart_'+Date.now(), name, type:'heatmap', dataLabel, heatmapData:heatmapTempData, data:[], goal:null });
            }
        } else {
            const goal = document.getElementById('dailyGoal').value ? parseFloat(document.getElementById('dailyGoal').value) : null;
            const dataLabel = document.getElementById('columnHeader').value || 'Value';
            const data = [];
            document.querySelectorAll('#dataTableBody tr').forEach(r=>{
                const date = r.querySelector('.data-date').value;
                const value = r.querySelector('.data-value').value;
                if (date && value) data.push({ date, value: parseFloat(value) });
            });
            data.sort((a,b)=>new Date(a.date)-new Date(b.date));
            if (currentEditingChart){
                const chart = appData.charts.find(c=>c.id===currentEditingChart);
                chart.name=name; chart.type=selectedChartType; chart.goal=goal; chart.dataLabel=dataLabel; chart.data=data; chart.heatmapData=[];
            } else {
                appData.charts.push({ id:'chart_'+Date.now(), name, type:selectedChartType, goal, dataLabel, data, heatmapData:[] });
            }
        }
        await saveData();
        updateDashboard();
        closeModal();
    }

    async function deleteChart(chartId){
        const chart = appData.charts.find(c=>c.id===chartId);
        if (chart && chart.permanent) { alert('This tracker cannot be deleted'); return; }
        if (!confirm('Delete this chart?')) return;
        appData.charts = appData.charts.filter(c=>c.id!==chartId);
        await saveData();
        updateDashboard();
        updateCalorieTracker();
    }

    /***********************
     * Meals & meal tracker rendering + coloring logic
     ***********************/
    function addMealEntry(mealType, time, calories){
        const mealTracker = appData.charts.find(c=>c.id==='meal_tracker');
        if (!mealTracker) return;
        if (!mealTracker.mealData) mealTracker.mealData=[];
        const today = new Date().toISOString().split('T')[0];
        mealTracker.mealData.push({ date: today, time: time, type: mealType, calories: parseFloat(calories) });
        saveData();
        updateMealTracker();
        updateCalorieTracker();
        updateProgressBar();
    }

    // quick add from meal input UI
    function addMealQuick(){
        const mealType = document.getElementById('mealTypeInput').value;
        const time = document.getElementById('mealTimeInput').value;
        const calories = document.getElementById('mealCalorieInput').value;
        if (!calories || calories <= 0) { alert('Enter valid calories'); return; }
        addMealEntry(mealType, time, calories);
        document.getElementById('mealCalorieInput').value='';
    }

    // compute minutes difference between two HH:MM strings (absolute)
    function minutesDiff(t1, t2){
        const [h1,m1] = t1.split(':').map(Number);
        const [h2,m2] = t2.split(':').map(Number);
        const mins1 = h1*60 + m1;
        const mins2 = h2*60 + m2;
        return Math.abs(mins1 - mins2);
    }

    function updateMealTracker(){
        const mealCard = document.querySelector('#meal_tracker_card');
        if (!mealCard) return;
        const mealTracker = appData.charts.find(c=>c.id==='meal_tracker'); if (!mealTracker) return;
        const today = new Date().toISOString().split('T')[0];
        const todayMeals = (mealTracker.mealData||[]).filter(m=>m.date===today);

        // timeline
        const timeline = mealCard.querySelector('.meal-timeline');
        if (timeline){
            timeline.querySelectorAll('.meal-marker').forEach(m=>m.remove());
            todayMeals.forEach(meal=>{
                const marker = document.createElement('div');
                marker.className = 'meal-marker';
                // position
                const [hours,minutes] = meal.time.split(':').map(Number);
                const totalMinutes = hours*60 + minutes;
                const percentage = (totalMinutes / 1440) * 100;
                marker.style.left = `${percentage}%`;
                marker.style.top = '50%';
                marker.title = `${meal.type}: ${meal.calories} kcal at ${meal.time}`;

                // color logic
                if (meal.type === 'snack') {
                    marker.style.background = 'var(--warning-yellow)';
                } else {
                    const ideal = appData.idealMealTimes?.[meal.type] || (meal.type==='breakfast'?'08:30': meal.type==='lunch'?'13:00':'18:00');
                    const mins = minutesDiff(meal.time, ideal);
                    if (mins <= 15) marker.style.background = 'var(--strava-orange)'; // standard orange
                    else if (mins <= 60) marker.style.background = 'var(--dark-orange)'; // darker orange
                    else marker.style.background = 'var(--danger-red)'; // red for big deviations
                }

                timeline.appendChild(marker);
            });
        }

        // update breakdown totals
        const breakdown = { breakfast:0, lunch:0, dinner:0, snack:0 };
        todayMeals.forEach(meal => { if (breakdown[meal.type] !== undefined) breakdown[meal.type]+=meal.calories; });

        ['breakfast','lunch','dinner','snack'].forEach(type=>{
            const el = mealCard.querySelector(`#${type}Calories`);
            if (el) el.textContent = Math.round(breakdown[type]);
        });
    }

    /***********************
     * Calorie tracker calculations
     ***********************/
    function updateCalorieTracker(){
        const today = new Date().toISOString().split('T')[0];
        const mealTracker = appData.charts.find(c=>c.id==='meal_tracker');
        let caloriesIn = 0;
        if (mealTracker && mealTracker.mealData) caloriesIn = mealTracker.mealData.filter(m=>m.date===today).reduce((s,m)=>s+m.calories,0);

        let caloriesOut = 0;
        const calorieChart = appData.charts.find(c=>c.id==='calories_burned');
        if (calorieChart && calorieChart.data){
            const todayData = calorieChart.data.find(d=>d.date===today);
            if (todayData) caloriesOut = todayData.value;
        }

        document.getElementById('caloriesIn').textContent = Math.round(caloriesIn);
        document.getElementById('caloriesOut').textContent = Math.round(caloriesOut);

        const netCalories = caloriesIn - caloriesOut;
        const netElement = document.getElementById('netCalories');
        const netStatElement = document.getElementById('netCaloriesStat');
        const tracker = document.getElementById('calorieTracker');

        if (netCalories < (appData.dailyCalorieTarget || 2000)){
            const deficit = (appData.dailyCalorieTarget || 2000) - netCalories;
            netElement.textContent = `-${Math.round(deficit)}`;
            netStatElement.classList.add('deficit'); netStatElement.classList.remove('surplus');
            tracker.classList.add('deficit'); tracker.classList.remove('surplus');
        } else {
            const surplus = netCalories - (appData.dailyCalorieTarget || 2000);
            netElement.textContent = `+${Math.round(surplus)}`;
            netStatElement.classList.remove('deficit'); netStatElement.classList.add('surplus');
            tracker.classList.remove('deficit'); tracker.classList.add('surplus');
        }

        document.getElementById('dailyTarget').textContent = appData.dailyCalorieTarget || 2000;
    }

    // Save calories burned from tracker UI (this is the permanent source of calories burned)
    async function saveCaloriesBurnedFromTracker(){
        const val = parseFloat(document.getElementById('trackerCaloriesBurnedInput').value);
        if (isNaN(val)) { alert('Enter a valid number'); return; }
        const today = new Date().toISOString().split('T')[0];
        const calorieChart = appData.charts.find(c=>c.id==='calories_burned');
        if (!calorieChart) { ensureCaloriesBurnedChart(); }
        const chart = appData.charts.find(c=>c.id==='calories_burned');
        if (!chart.data) chart.data=[];
        const idx = chart.data.findIndex(d=>d.date===today);
        if (idx!==-1) chart.data[idx].value = val;
        else { chart.data.push({ date:today, value: val }); chart.data.sort((a,b)=>new Date(a.date)-new Date(b.date)); }
        await saveData();
        updateDashboard();
        updateCalorieTracker();
        updateProgressBar();
        document.getElementById('trackerCaloriesBurnedInput').value='';
    }
    function clearTrackerBurnInput(){ document.getElementById('trackerCaloriesBurnedInput').value=''; }

    /***********************
     * Progress bar & totals
     ***********************/
    function updateProgressBar(){
        if (!appData.currentWeight || !appData.targetWeight) return;
        const weightToLose = appData.currentWeight - appData.targetWeight;
        const totalDeficitNeeded = Math.max(0, weightToLose * 7000); // 7000 kcal/kg
        let totalDeficitAchieved = 0;

        const mealTracker = appData.charts.find(c=>c.id==='meal_tracker');
        const calorieChart = appData.charts.find(c=>c.id==='calories_burned');
        const dates = new Set();
        if (mealTracker && mealTracker.mealData) mealTracker.mealData.forEach(m=>dates.add(m.date));
        if (calorieChart && calorieChart.data) calorieChart.data.forEach(d=>dates.add(d.date));

        dates.forEach(date=>{
            const dayMeals = (mealTracker && mealTracker.mealData) ? mealTracker.mealData.filter(m=>m.date===date).reduce((s,m)=>s+m.calories,0) : 0;
            const dayBurn = (calorieChart && calorieChart.data) ? (calorieChart.data.find(d=>d.date===date)?.value || 0) : 0;
            const dayNet = dayMeals - dayBurn;
            if (dayNet < (appData.dailyCalorieTarget || 2000)) totalDeficitAchieved += ((appData.dailyCalorieTarget || 2000) - dayNet);
        });

        const remaining = Math.max(0, totalDeficitNeeded - totalDeficitAchieved);
        const percentage = totalDeficitNeeded === 0 ? 0 : Math.min(100, (totalDeficitAchieved / totalDeficitNeeded) * 100);

        document.getElementById('totalDeficitNeeded').textContent = Math.round(totalDeficitNeeded).toLocaleString();
        document.getElementById('deficitAchieved').textContent = Math.round(totalDeficitAchieved).toLocaleString();
        document.getElementById('deficitRemaining').textContent = Math.round(remaining).toLocaleString();
        document.getElementById('progressPercentage').textContent = Math.round(percentage);

        const cellsContainer = document.getElementById('progressCells');
        const cellsToFill = Math.round((percentage/100)*20);
        let cellsHTML = '';
        for (let i=0;i<20;i++) cellsHTML += `<div class="progress-cell ${i<cellsToFill?'filled':''}"></div>`;
        cellsContainer.innerHTML = cellsHTML;
    }

    /***********************
     * Dashboard rendering
     ***********************/
    function updateDashboard(){
        const content = document.getElementById('dashboardContent');
        const chartCount = appData.charts.filter(c=>!c.permanent).length;
        document.getElementById('dashboardSubtitle').textContent = chartCount===0 ? 'Start tracking your personal metrics' : `Tracking ${chartCount} metric${chartCount!==1?'s':''}`;
        content.innerHTML = '<div class="dashboard-grid" id="chartsGrid"></div>';
        const grid = document.getElementById('chartsGrid');

        if (appData.charts.filter(c=>!c.permanent).length === 0){
            const emptyState = document.createElement('div'); emptyState.className='empty-state';
            emptyState.innerHTML = `
                <div class="empty-state-icon">📊</div>
                <h2 class="empty-state-title">Welcome to PERFORMANCE</h2>
                <p class="empty-state-text">Start tracking your metrics to see your progress</p>
                <button class="btn-primary" onclick="openAddModal()">+ Add Your First Chart</button>
            `;
            grid.appendChild(emptyState);
        }

        appData.charts.forEach((chart,index)=>{
            const card = createChartCard(chart, index);
            grid.appendChild(card);
        });

        updateCalorieTracker();
        updateProgressBar();
    }

    function createChartCard(chart, index){
        const card = document.createElement('div');

        if (chart.id === 'meal_tracker'){
            card.className = 'meal-tracker-card'; card.id = 'meal_tracker_card';
            card.innerHTML = `
                <div class="chart-header"><h3 class="chart-title">MEAL TRACKER</h3></div>
                <div class="meal-input-section">
                    <select class="meal-type-select" id="mealTypeInput">
                        <option value="breakfast">Breakfast</option>
                        <option value="lunch">Lunch</option>
                        <option value="dinner">Dinner</option>
                        <option value="snack">Snack</option>
                    </select>
                    <input type="time" class="meal-time-input" id="mealTimeInput" value="${new Date().toTimeString().slice(0,5)}"/>
                    <input type="number" class="meal-calorie-input" id="mealCalorieInput" placeholder="Calories"/>
                    <button class="add-meal-btn" onclick="addMealQuick()">ADD</button>
                </div>
                <div class="meal-visualizations">
                    <div class="meal-viz-section">
                        <div class="meal-viz-title">Meal Timeline Today</div>
                        <div class="meal-timeline">
                            <div class="meal-timeline-axis"></div>
                        </div>
                        <div class="time-labels">
                            <span>12AM</span><span>6AM</span><span>12PM</span><span>6PM</span><span>12AM</span>
                        </div>
                    </div>
                    <div class="meal-viz-section">
                        <div class="meal-viz-title">Calorie Breakdown</div>
                        <div class="calorie-breakdown">
                            <div class="meal-category"><span class="meal-category-name">🌅 Breakfast</span><span class="meal-category-calories" id="breakfastCalories">0</span></div>
                            <div class="meal-category"><span class="meal-category-name">☀️ Lunch</span><span class="meal-category-calories" id="lunchCalories">0</span></div>
                            <div class="meal-category"><span class="meal-category-name">🌙 Dinner</span><span class="meal-category-calories" id="dinnerCalories">0</span></div>
                            <div class="meal-category"><span class="meal-category-name">🍿 Snacks</span><span class="meal-category-calories" id="snackCalories">0</span></div>
                        </div>
                    </div>
                </div>
            `;
            // allow update of meal tracker render after insertion
            setTimeout(()=>{ updateMealTracker(); }, 100);
            return card;
        }

        // regular charts
        card.className = 'chart-card';
        if (index===1 && chart.type !== 'heatmap') card.className += ' large';

        // heatmap or chart rendering placeholder
        if (chart.type === 'heatmap'){
            card.innerHTML = `<div class="chart-header"><h3 class="chart-title">${chart.name}</h3>
                <div class="chart-menu"><button class="menu-dots" onclick="toggleMenu('${chart.id}')">⋯</button>
                <div class="menu-dropdown" id="menu_${chart.id}"><button class="menu-item" onclick="openEditModal('${chart.id}')">Edit Chart</button><button class="menu-item" onclick="deleteChart('${chart.id}')">Delete Chart</button></div>
                </div></div><div id="heatmap_${chart.id}"></div>`;
            setTimeout(()=>renderHeatmap(chart), 150);
            return card;
        } else {
            const latestValue = (chart.data && chart.data.length>0) ? chart.data[chart.data.length-1].value : 0;
            const prevValue = (chart.data && chart.data.length>1) ? chart.data[chart.data.length-2].value : null;
            let trend = '';
            if (prevValue !== null && prevValue !== 0) {
                const change = ((latestValue - prevValue)/prevValue)*100;
                trend = `${change>=0?'+':''}${change.toFixed(1)}%`;
            }
            card.innerHTML = `<div class="chart-header"><h3 class="chart-title">${chart.name}</h3>
                <div class="chart-menu"><button class="menu-dots" onclick="toggleMenu('${chart.id}')">⋯</button>
                <div class="menu-dropdown" id="menu_${chart.id}"><button class="menu-item" onclick="openEditModal('${chart.id}')">Edit Chart</button><button class="menu-item" onclick="deleteChart('${chart.id}')">Delete Chart</button></div>
                </div></div>
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <div style="font-size:28px; font-weight:700; color:var(--strava-orange);">${latestValue}</div>
                    <div style="font-size:12px; color:var(--strava-text-secondary);">${chart.dataLabel || ''} ${trend?` • ${trend}`:''}</div>
                </div>
                <div class="chart-container" id="chart_${chart.id}" style="height:220px; margin-top:12px;"></div>`;
            setTimeout(()=>renderChart(chart), 150);
            return card;
        }
    }

    function toggleMenu(chartId){
        const menu = document.getElementById(`menu_${chartId}`);
        if (!menu) return;
        menu.classList.toggle('active');
        document.querySelectorAll('.menu-dropdown').forEach(m=>{ if (m.id !== `menu_${chartId}`) m.classList.remove('active'); });
    }

    /***********************
     * Chart rendering helpers
     * (kept simple — Chart.js usage)
     ***********************/
    function renderChart(chartData){
        const el = document.getElementById(`chart_${chartData.id}`);
        if (!el) return;
        el.innerHTML = `<canvas id="canvas_${chartData.id}"></canvas>`;
        const canvas = document.getElementById(`canvas_${chartData.id}`);
        const labels = (chartData.data||[]).map(d=>d.date);
        const values = (chartData.data||[]).map(d=>d.value);
        const datasets = [{
            label: chartData.dataLabel || 'Value',
            data: values,
            borderColor: '#FC4C02',
            backgroundColor: chartData.type==='bar' ? 'rgba(252,76,2,0.8)' : 'rgba(252,76,2,0.12)',
            tension: 0.4,
            fill: chartData.type==='line',
            borderWidth: 2,
            pointBackgroundColor: '#FC4C02'
        }];
        if (chartData.goal) datasets.push({ label:'Goal', data:Array(labels.length).fill(chartData.goal), borderDash:[5,5], borderColor:'#00D964', borderWidth:2, pointRadius:0, fill:false });
        new Chart(canvas, { type: chartData.type==='line' ? 'line' : 'bar', data:{ labels, datasets }, options:{ responsive:true, maintainAspectRatio:false } });
    }

    // lightweight heatmap render
    function renderHeatmap(chartData, weekOffset=0){
        const container = document.getElementById(`heatmap_${chartData.id}`); if (!container) return;
        // very simple week heatmap using chartData.heatmapData
        const now = new Date();
        const start = new Date(now); start.setHours(0,0,0,0);
        start.setDate(start.getDate() - start.getDay() + (weekOffset*7));
        const end = new Date(start); end.setDate(start.getDate()+6); end.setHours(23,59,59,999);
        const weekData = (chartData.heatmapData||[]).filter(e=>{ const d=new Date(e.datetime); return d>=start && d<=end; });
        // aggregate
        const grid = Array.from({length:24}, ()=>Array(7).fill(0));
        let maxIntensity = 1;
        weekData.forEach(entry=>{
            const d = new Date(entry.datetime);
            grid[d.getHours()][d.getDay()] = Math.max(grid[d.getHours()][d.getDay()], entry.intensity);
            maxIntensity = Math.max(maxIntensity, entry.intensity);
        });
        // build html
        let html = `<div class="week-navigator">
            <button class="week-nav-btn" onclick="renderHeatmap(${JSON.stringify(chartData)}, ${weekOffset-1})">← PREV</button>
            <span class="week-label">${start.toLocaleDateString('en-US',{month:'short',day:'numeric'})} - ${end.toLocaleDateString('en-US',{month:'short',day:'numeric'})}</span>
            <button class="week-nav-btn" onclick="renderHeatmap(${JSON.stringify(chartData)}, ${weekOffset+1})">NEXT →</button>
        </div><div class="heatmap-container"><table class="heatmap-table"><thead><tr><th></th><th>SUN</th><th>MON</th><th>TUE</th><th>WED</th><th>THU</th><th>FRI</th><th>SAT</th></tr></thead><tbody>`;
        for (let hour=0; hour<24; hour++){
            html += `<tr><td class="hour-label">${hour===0?'12A':hour<12?hour+'A':hour===12?'12P':(hour-12)+'P'}</td>`;
            for (let d=0; d<7; d++){
                const intensity = grid[hour][d];
                let bg = 'var(--strava-dark)';
                if (intensity>0){
                    const opacity = intensity / maxIntensity;
                    const r = 252; const g = Math.round(76 + (200-76)*(1-opacity)); const b = Math.round(2 + (150-2)*(1-opacity));
                    bg = `rgb(${r},${g},${b})`;
                }
                html += `<td style="background-color:${bg}; width:40px; height:18px;"></td>`;
            }
            html += '</tr>';
        }
        html += '</tbody></table></div>';
        container.innerHTML = html;
    }

    /***********************
     * Save calories burned direct from tracker code already added above
     ***********************/

    /***********************
     * Misc helpers
     ***********************/
    function openGithubSettings(){ openSettingsModal(); } // merged into settings
    function skipGithubSetup(){ githubConfig.useGithub = false; localStorage.setItem('githubConfig', JSON.stringify(githubConfig)); updateSyncStatus('offline','Local Storage'); }

    /***********************
     * Start
     ***********************/
    // Expose a few functions to global scope so inline onclicks work
    window.openAddModal = openAddModal;
    window.openSettingsModal = openSettingsModal;
    window.closeSettingsModal = closeSettingsModal;
    window.saveSettings = saveSettings;
    window.openDailyUpdateModal = openDailyUpdateModal;
    window.closeDailyUpdateModal = closeDailyUpdateModal;
    window.saveDailyUpdate = saveDailyUpdate;
    window.openEditModal = openEditModal;
    window.closeModal = closeModal;
    window.selectChartType = selectChartType;
    window.addDataRow = addDataRow;
    window.deleteDataRow = deleteDataRow;
    window.addHeatmapEntry = addHeatmapEntry;
    window.addMealQuick = addMealQuick;
    window.saveChart = saveChart;
    window.deleteChart = deleteChart;
    window.saveCaloriesBurnedFromTracker = saveCaloriesBurnedFromTracker;
    window.clearTrackerBurnInput = clearTrackerBurnInput;
    window.skipSetup = skipSetup;
    window.setTarget = setTarget;

    </script>
</body>
</html>
